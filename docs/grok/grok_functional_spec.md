# Grok 支持功能说明文档

## 1. 现状与痛点

| 环节 | 目前做法 | 痛点 |
| --- | --- | --- |
| 日志采集后清洗 | 用户在 UI 中填写正则表达式，将字段通过捕获组提取 | 正则复杂度高、表达式难以复用，易出错 |
| 关键字/告警匹配 | 直接输入正则或通配符 | 同类模式分散，维护成本高 |
| 模式复用 | 通过文档或截图传播 | 无官方库，缺少权限控制 |

> **集成位置**：凡是可输入正则的地方（清洗规则、关键词匹配、通知过滤、采集侧 Agent 校验等），提供 “使用 Grok 模板” 的入口；解析结果与原正则路径保持一致，无需改动后续流水线。

## 2. Grok 引入目标

1. **降低正则门槛**：使用语义化模式组合（`%{IPV4}`、`%{TIMESTAMP_ISO8601}` 等）快速构建表达式。
2. **统一模式复用**：平台内置与自定义 Grok 模式库，支持版本与权限控制。
3. **保持兼容**：同一输入框兼容 “纯正则” 与 “Grok 表达式”，能够相互转换或回退。

## 3. 用户故事

- **采集管理员**：在清洗规则里，选择 “Grok” 模式，引用自定义 `%{NGINX_ACCESSLOG}` 模板快速提取字段。
- **值班工程师**：在告警策略中调用共享 Grok 模式 `%{JAVA_EXCEPTION}`，无需重新编写正则。
- **平台管理员**：维护 Grok 模式库（新增/审核/下线），并审计引用关系。

## 4. 功能清单

### 4.1 Grok 解析能力
1. 输入框新增模式切换：
   - `正则模式`：沿用现有功能。
   - `Grok 模式`：输入 `%{PATTERN:field}` 语法，可嵌套。
2. 实时校验：在前端解析 Grok 并提示命名字段、报错位置。
3. 预览：选取样例日志，展示结构化字段，支持与 JSON Schema 对比。

### 4.2 模式库管理

| 功能 | 描述 |
| --- | --- |
| 列表 | 查看内置/自定义 Grok 模式，展示定义、版本、最后修改人、引用数量 |
| 新增/编辑 | 在线编写 Grok 定义，支持引用其他模式；保存前执行语法与样例校验 |
| 版本与审计 | 每次修改生成新版本，可快速回滚；记录变更审计 |
| 权限 | 支持“工作空间级”“平台级”共享；可限制特定团队使用 |
| 导入/导出 | 兼容 Logstash/Elastic Grok 文件，便于迁移 |

### 4.3 API 与后端能力

| API | 方法 | 说明 |
| --- | --- | --- |
| `/api/grok/patterns` | GET | 列出可见的 Grok 模式 |
| `/api/grok/patterns` | POST | 创建模式（需校验唯一性/语法） |
| `/api/grok/patterns/{id}` | PUT/DELETE | 更新或下线模式 |
| `/api/grok/compile` | POST | 输入 Grok 字符串与样例日志，返回解析结构/错误 |
| `/api/grok/library/import` | POST | 批量导入 Grok 文件 |

> 解析引擎可沿用开源 Grok（Oniguruma/Java Grok）或自研模块，封装为服务，供 UI 与任务执行双方调用。

### 4.4 UI/UX 流程

1. **清洗规则编辑器**
   - Tab：`正则` / `Grok` / `可视化`。
   - Grok Tab 中提供模式库选择器（树形分类）与预览窗。
2. **模式库页面**
   - 左侧分类（内置 / 我的团队 / 平台共享）。
   - 右侧列表 + 详情（定义、引用位置、示例输出）。
   - 支持复制引用语句、下载 JSON Schema。
3. **引用追踪**
   - 在模式详情页展示“被哪些规则/策略使用”，变更时给这些引用方预警。

### 4.5 权限与治理

- **角色**：普通用户（仅读）、项目管理员（创建/编辑本项目模式）、平台管理员（全局管理、审批发布）。
- **审批流**：自定义模式提交后可选审批节点再发布。
- **配额**：限制每项目模式数量、大小，防止滥用。

## 5. 回退与兼容策略

1. 所有 Grok 表达式在保存时转换为等效正则并缓存，运行期仍使用成熟的 regex 引擎，避免执行链改造。
2. 在 UI 中提供 “展开为正则” 按钮，方便问题定位。
3. 若 Grok 解析失败或模式被下线，自动回退到最近一次成功的版本，并提示用户。

## 6. 发布与迭代

1. **MVP**：提供基础 Grok 输入 + 预览 + 内置模式。
2. **二期**：上线模式库 CRUD、版本、权限。
3. **三期**：支持导入/导出、引用追踪、自动化治理报表。

## 7. HTML Demo 说明

伴随本说明提供 `grok_demo.html` 示例，展示：

- 选择/创建 Grok 模式。
- 输入日志样本并解析为结构化 JSON。
- 模式库 CRUD（基于浏览器 localStorage 的 mock）。
- 可在“正则模式”下直接输入传统 regex，以示兼容。



