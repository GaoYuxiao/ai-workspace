# 统一日志检索平台 需求文档

**版本**：v1.0  
**日期**：2026-02-02  
**文档状态**：初稿

---

## 1. 背景与目标

### 1.1 业务背景

当前企业内部存在多种类型的日志数据，分布在不同的场景和基础设施中：

| 场景类型 | 数据来源 | 典型用途 |
|---------|---------|---------|
| **容器日志** | Kubernetes 集群中的 Pod/容器 | 微服务应用日志、容器运行时日志 |
| **主机日志** | 物理机/虚拟机上的日志文件 | 系统日志、应用日志、安全审计日志 |
| **PaaS 日志** | PaaS 平台服务产生的日志 | 平台运维日志、服务治理日志 |
| **服务日志** | 业务服务产生的结构化日志 | 业务运营日志、接口调用日志 |
| **客户端日志** | 移动端/PC端用户上报的日志 | 崩溃日志、性能日志、用户行为日志 |
| **TRPC 日志** | TRPC 框架产生的日志 | RPC 调用链日志、服务间通信日志 |

**当前挑战**：

| 挑战 | 描述 |
|-----|------|
| **入口分散** | 不同场景的日志需要在不同的页面/工具中查询，学习成本高 |
| **过滤复杂** | 日志库和索引集众多，用户难以选择正确的数据源 |
| **上下文缺失** | 基于资源的过滤方式，用户需要知道日志库与资源的映射关系 |
| **效率低下** | 跨场景排查问题时需要频繁切换工具和页面 |

### 1.2 产品目标

构建统一的日志检索平台，核心目标：

1. **统一入口**：为所有类型的日志提供统一的检索入口
2. **资源驱动**：支持基于资源（集群、Pod、主机等）直接过滤日志，无需关心底层日志库
3. **场景适配**：针对不同场景提供差异化的过滤条件，满足各场景的特定需求
4. **灵活查询**：同时支持资源过滤和传统的日志库+条件组两种查询模式
5. **高效检索**：支持 Lucene 语法，提供强大的全文检索能力

### 1.3 核心设计理念

> **以资源为中心，以场景为导向，让用户专注于问题排查而非数据源选择。**

核心价值主张：

```
选择场景 → 选择资源 → 输入查询 → 获取结果
```

用户不再需要：
- 记忆日志库与资源的映射关系
- 在多个索引集中寻找正确的数据源
- 手动拼接复杂的过滤条件

---

## 2. 页面结构设计

### 2.1 页面总览

统一日志检索平台采用单页面设计，通过过滤方案切换和场景切换来适配不同的使用模式。

```
┌─────────────────────────────────────────────────────────────────┐
│  过滤方案:  [资源过滤] [日志库+条件组]                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [容器] [主机] [PaaS] [服务] [客户端] [TRPC]              │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  资源过滤区域（根据场景动态变化）                          │   │
│  │                                                         │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │
│  │  │ 条件1   │ │ 条件2   │ │ 条件3   │ │ 条件4   │       │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🔍 输入查询语句，支持 Lucene 语法。输入 @ 可快速选择...    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                      [查询]     │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        日志查询结果区域                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心区域说明

| 区域 | 说明 |
|-----|------|
| **过滤方案切换** | 在「资源过滤」和「日志库+条件组」两种模式间切换 |
| **场景切换** | 在容器、主机、PaaS、服务、客户端、TRPC 场景间切换 |
| **资源过滤区域** | 根据场景展示不同的资源过滤条件 |
| **查询输入框** | 支持 Lucene 语法的查询条件输入 |
| **结果展示区域** | 展示日志查询结果 |

---

## 3. 功能详细设计

### 3.1 过滤方案切换

#### 3.1.1 功能描述

提供两种过滤方案，用户可根据使用习惯和场景需求进行切换。

#### 3.1.2 过滤方案对比

| 方案 | 适用场景 | 优势 | 劣势 |
|-----|---------|------|------|
| **资源过滤** | 基于资源进行问题排查，不熟悉日志库结构 | 以资源为中心，自动关联日志库 | 需要知道资源信息 |
| **日志库+条件组** | 熟悉日志库结构，需要精确控制查询范围 | 直接选择日志库，精确控制 | 需要了解日志库与资源的映射关系 |

#### 3.1.3 资源过滤模式

**核心特点**：
- 用户选择资源（如集群、Pod、主机等）
- 系统自动根据资源关联到对应的日志库
- 用户无需关心底层数据源

**交互方式**：
- 默认选中此模式
- 切换到此模式时，展示场景选择和资源过滤条件

#### 3.1.4 日志库+条件组模式

**核心特点**：
- 用户直接选择日志库/索引集
- 用户自定义过滤条件组
- 完全控制查询范围

**交互方式**：
- 切换到此模式时，隐藏场景选择和资源过滤条件
- 展示日志库选择和条件组配置

---

### 3.2 场景切换

#### 3.2.1 功能描述

根据日志来源的不同场景，提供差异化的资源过滤条件。

#### 3.2.2 支持场景

| 场景 | 图标 | 说明 |
|-----|------|------|
| 容器 | 🐳 | Kubernetes 容器场景 |
| 主机 | 🖥️ | 物理机/虚拟机场景 |
| PaaS | ☁️ | PaaS 平台场景 |
| 服务 | ⚙️ | 业务服务场景 |
| 客户端 | 📱 | 移动端/PC端场景 |
| TRPC | ⚡ | TRPC 框架场景 |

#### 3.2.3 交互方式

- Tab 切换形式
- 切换场景时，资源过滤条件区域联动更新
- 保持查询输入框内容不变
- 切换后自动清空或保留可复用的过滤条件（可配置）

---

### 3.3 资源过滤条件

#### 3.3.1 容器场景

**过滤条件列表**：

| 字段 | 说明 | 必填 | 支持多选 |
|-----|------|-----|---------|
| 集群 | Kubernetes 集群 | 是 | 否 |
| 命名空间 | Namespace | 否 | 是 |
| 工作负载类型 | Deployment/StatefulSet/DaemonSet 等 | 否 | 是 |
| 工作负载名称 | 工作负载的名称 | 否 | 是 |
| Pod 名称 | Pod 的名称 | 否 | 是 |
| 容器名称 | Container 的名称 | 否 | 是 |
| 节点 IP | Node 的 IP 地址 | 否 | 是 |
| 路径 | 日志文件路径 | 否 | 是 |

**过滤条件联动**：

```
集群 → 命名空间 → 工作负载类型 → 工作负载名称 → Pod名称 → 容器名称
                                                    ↓
                                               节点IP、路径
```

选择上级条件后，下级条件的可选值自动过滤。

#### 3.3.2 主机场景

**过滤条件列表**：

| 字段 | 说明 | 必填 | 支持多选 |
|-----|------|-----|---------|
| 主机 IP | 主机的 IP 地址 | 否 | 是 |
| 主机名 | 主机的 hostname | 否 | 是 |
| 操作系统 | Linux/Windows 等 | 否 | 是 |
| 云区域 | 云区域标识 | 否 | 是 |
| 日志路径 | 日志文件路径 | 否 | 是 |

#### 3.3.3 PaaS 场景

**过滤条件列表**：

| 字段 | 说明 | 必填 | 支持多选 |
|-----|------|-----|---------|
| 应用 ID | PaaS 应用标识 | 否 | 是 |
| 模块 | 应用模块 | 否 | 是 |
| 环境 | 正式环境/预发布环境/开发环境 | 否 | 是 |
| 进程 | 进程名称 | 否 | 是 |

#### 3.3.4 服务场景

**过滤条件列表**：

| 字段 | 说明 | 必填 | 支持多选 |
|-----|------|-----|---------|
| 服务名称 | 业务服务名称 | 否 | 是 |
| 接口名称 | API 接口名称 | 否 | 是 |
| 实例 IP | 服务实例的 IP | 否 | 是 |
| 日志级别 | DEBUG/INFO/WARN/ERROR | 否 | 是 |

#### 3.3.5 客户端场景

**过滤条件列表**：

| 字段 | 说明 | 必填 | 支持多选 |
|-----|------|-----|---------|
| 用户 ID | 用户唯一标识 | 否 | 是 |
| 设备 ID | 设备唯一标识 | 否 | 是 |
| App 版本 | 客户端版本号 | 否 | 是 |
| 平台 | iOS/Android/Windows/Mac | 否 | 是 |
| 渠道 | 下载渠道标识 | 否 | 是 |

#### 3.3.6 TRPC 场景

**过滤条件列表**：

| 字段 | 说明 | 必填 | 支持多选 |
|-----|------|-----|---------|
| 调用方服务 | 发起调用的服务名 | 否 | 是 |
| 被调方服务 | 被调用的服务名 | 否 | 是 |
| 接口名称 | RPC 接口名称 | 否 | 是 |
| 调用结果 | 成功/失败 | 否 | 是 |
| 实例 IP | 服务实例 IP | 否 | 是 |

---

### 3.4 查询输入框

#### 3.4.1 功能描述

提供统一的查询输入框，支持 Lucene 语法和快捷选择功能。

#### 3.4.2 Lucene 语法支持

**支持的语法元素**：

| 语法 | 说明 | 示例 |
|-----|------|------|
| 关键词搜索 | 全文匹配关键词 | `error` |
| 字段搜索 | 指定字段搜索 | `level:ERROR` |
| 短语搜索 | 精确短语匹配 | `"connection refused"` |
| 通配符 | 模糊匹配 | `err*`, `erro?` |
| 布尔运算 | AND/OR/NOT 组合 | `error AND timeout` |
| 分组 | 条件分组 | `(error OR warn) AND database` |
| 范围查询 | 数值/日期范围 | `response_time:[100 TO 500]` |
| 正则表达式 | 正则匹配 | `/err.*/` |

#### 3.4.3 @ 快捷选择

**功能描述**：输入 `@` 字符时，弹出快捷选择菜单。

**可选择的内容**：

| 类型 | 说明 |
|-----|------|
| 采集项 | 快速选择预定义的采集项 |
| 索引集 | 快速选择索引集作为数据源 |
| 条件组 | 快速应用保存的条件组 |

**交互方式**：
- 输入 `@` 后自动弹出下拉菜单
- 支持模糊搜索过滤
- 选中后自动填充到查询框

#### 3.4.4 查询历史

**功能描述**：记录用户的查询历史，方便快速重复查询。

**功能要点**：
- 保存最近 50 条查询记录
- 支持按场景分类展示
- 支持删除单条或清空历史
- 点击历史记录自动填充

---

### 3.5 查询操作

#### 3.5.1 查询按钮

**功能描述**：执行日志查询。

**交互方式**：
- 点击「查询」按钮执行查询
- 支持快捷键 `Ctrl/Cmd + Enter` 执行查询
- 查询执行中显示 loading 状态
- 查询完成后展示结果

#### 3.5.2 确认查询按钮

**功能描述**：在资源过滤模式下，先确认资源选择，再进入查询结果页。

**交互方式**：
- 点击后验证资源过滤条件
- 资源过滤条件不满足最低要求时提示用户
- 满足条件后执行查询并展示结果

#### 3.5.3 设置按钮

**功能描述**：配置查询相关的高级选项。

**可配置内容**：
- 时间范围设置
- 返回条数限制
- 排序方式
- 结果展示格式
- 默认场景设置

---

### 3.6 结果展示区域

#### 3.6.1 功能描述

展示日志查询结果，提供浏览、筛选、分析等功能。

#### 3.6.2 结果列表

**展示内容**：

| 字段 | 说明 |
|-----|------|
| 时间 | 日志产生时间 |
| 来源 | 日志来源（Pod/主机/服务等） |
| 级别 | 日志级别（DEBUG/INFO/WARN/ERROR） |
| 内容 | 日志内容（支持展开/折叠） |

**交互功能**：
- 支持按时间排序（正序/倒序）
- 支持关键词高亮
- 支持展开查看完整日志
- 支持复制单条日志
- 支持查看日志上下文

#### 3.6.3 快捷筛选

**功能描述**：在结果中快速添加筛选条件。

**操作方式**：
- 点击字段值，选择「添加到筛选」或「从筛选中排除」
- 筛选条件自动添加到查询框
- 支持多条件组合

#### 3.6.4 字段统计

**功能描述**：对结果中的字段进行统计分析。

**统计内容**：
- 按字段值分布统计
- 按时间分布统计
- Top N 值展示

---

## 4. 资源与日志库映射

### 4.1 映射机制

**核心逻辑**：

系统后台维护资源与日志库的映射关系，用户选择资源后，自动关联到对应的日志库。

```
资源选择 → 映射查询 → 日志库确定 → 执行查询
```

### 4.2 映射规则

#### 4.2.1 容器场景映射

| 资源条件 | 映射逻辑 |
|---------|---------|
| 集群 + 命名空间 | 查找该命名空间关联的容器日志索引集 |
| Pod 名称 | 通过 Pod 标签关联到对应的日志采集配置 |
| 容器名称 | 通过容器名称匹配日志采集路径 |

#### 4.2.2 主机场景映射

| 资源条件 | 映射逻辑 |
|---------|---------|
| 主机 IP | 通过 IP 地址关联到主机上配置的采集项 |
| 日志路径 | 匹配对应路径的日志索引集 |

#### 4.2.3 其他场景映射

各场景根据业务特点定义相应的映射规则，由管理员在后台配置。

### 4.3 映射配置

**管理入口**：系统管理 → 日志检索配置 → 资源映射管理

**配置内容**：
- 场景定义
- 资源类型定义
- 资源与日志库的映射规则
- 映射优先级

---

## 5. 技术实现要点

### 5.1 前端架构

**技术栈**：
- Vue 3 / React
- 组件库：蓝鲸 MagicBox / Ant Design
- 状态管理：Pinia / Redux

**关键组件**：
- 过滤方案切换组件
- 场景 Tab 组件
- 动态表单组件（资源过滤条件）
- 查询编辑器组件（支持 Lucene 语法高亮）
- 日志结果列表组件

### 5.2 后端架构

**核心服务**：
- 资源映射服务：管理资源与日志库的映射关系
- 查询转换服务：将资源过滤条件转换为日志库查询条件
- 日志查询服务：执行日志检索

**依赖服务**：
- CMDB：获取资源元数据
- 日志平台：执行日志查询
- 容器平台：获取 K8s 资源信息

### 5.3 性能优化

**前端优化**：
- 过滤条件联动异步加载
- 结果列表虚拟滚动
- 查询防抖处理

**后端优化**：
- 资源映射缓存
- 查询结果分页
- 索引集预选优化

---

## 6. 优先级规划

### 6.1 阶段一：MVP（P0）

| 功能 | 说明 |
|-----|------|
| 过滤方案切换 | 资源过滤 / 日志库+条件组 切换 |
| 容器场景 | 容器场景的完整资源过滤能力 |
| 主机场景 | 主机场景的完整资源过滤能力 |
| 查询输入框 | 支持 Lucene 语法 |
| 结果展示 | 基础的日志列表展示 |

**目标**：覆盖最常用的容器和主机场景，提供统一的检索入口。

### 6.2 阶段二：场景扩展（P1）

| 功能 | 说明 |
|-----|------|
| PaaS 场景 | PaaS 场景的资源过滤能力 |
| 服务场景 | 服务场景的资源过滤能力 |
| 客户端场景 | 客户端场景的资源过滤能力 |
| TRPC 场景 | TRPC 场景的资源过滤能力 |
| @ 快捷选择 | 输入 @ 快速选择采集项/索引集/条件组 |

**目标**：覆盖所有业务场景。

### 6.3 阶段三：体验优化（P2）

| 功能 | 说明 |
|-----|------|
| 查询历史 | 保存和管理查询历史 |
| 快捷筛选 | 在结果中快速添加筛选条件 |
| 字段统计 | 对结果字段进行统计分析 |
| 高级设置 | 查询高级配置选项 |
| 收藏功能 | 收藏常用的查询条件组合 |

**目标**：提升用户体验和查询效率。

---

## 7. 附录

### 7.1 术语表

| 术语 | 说明 |
|-----|------|
| 资源过滤 | 基于资源（集群、Pod、主机等）进行日志过滤的方式 |
| 日志库 | 日志数据的存储单元，通常对应一个索引集 |
| 索引集 | 日志平台中的数据索引，用于日志检索 |
| 采集项 | 定义了日志采集规则的配置项 |
| 条件组 | 预定义的过滤条件组合，可以快速应用 |
| Lucene | Apache Lucene 查询语法，广泛用于日志检索 |

### 7.2 场景过滤条件速查表

| 场景 | 核心过滤条件 |
|-----|-------------|
| 容器 | 集群、命名空间、工作负载、Pod、容器、节点IP、路径 |
| 主机 | 主机IP、主机名、操作系统、云区域、日志路径 |
| PaaS | 应用ID、模块、环境、进程 |
| 服务 | 服务名称、接口名称、实例IP、日志级别 |
| 客户端 | 用户ID、设备ID、App版本、平台、渠道 |
| TRPC | 调用方服务、被调方服务、接口名称、调用结果、实例IP |

### 7.3 Lucene 语法速查

```
# 基础搜索
error                     # 搜索包含 error 的日志
"connection refused"      # 搜索精确短语

# 字段搜索
level:ERROR               # 指定字段搜索
status:[400 TO 500]       # 范围搜索

# 布尔运算
error AND timeout         # AND 组合
error OR exception        # OR 组合
error NOT debug           # NOT 排除

# 通配符
err*                      # 匹配 err 开头
erro?                     # 匹配单个字符

# 分组
(error OR warn) AND db    # 条件分组
```

---

**文档结束**
