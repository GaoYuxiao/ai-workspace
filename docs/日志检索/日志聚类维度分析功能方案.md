# 日志聚类维度分析功能方案

> 版本：v1.0  
> 创建日期：2026-01-27  
> 核心能力：基于聚类签名的变量字段进行维度下钻分析

---

## 一、功能定位

### 1.1 核心概念

日志聚类会将原始日志抽象为**签名模式**，其中的可变部分用占位符表示：

```
原始日志：
ERROR: Failed to load item item_weapon_001, code: 404
ERROR: Failed to load item item_armor_002, code: 500
ERROR: Failed to load item item_helmet_003, code: 404

聚类签名：
ERROR: Failed to load item <ITEM_ID>, code: <ERROR_CODE>
                          ─────────        ──────────
                          变量字段①         变量字段②
```

**维度分析**就是对这些变量字段的实际值进行统计和下钻。

### 1.2 解决的问题

| 问题 | 维度分析如何解决 |
|------|----------------|
| 这个错误影响了哪些资源？ | 分析 `<ITEM_ID>` 的分布 |
| 主要是什么错误码？ | 分析 `<ERROR_CODE>` 的分布 |
| 哪个资源问题最严重？ | 按 `<ITEM_ID>` 排序，找到 Top N |
| 404 错误主要影响哪些资源？ | 筛选 `<ERROR_CODE>=404`，再看 `<ITEM_ID>` 分布 |

---

## 二、维度来源

### 2.1 维度提取规则

签名中的占位符就是可分析的维度：

| 占位符类型 | 匹配规则 | 维度名称（自动生成） | 示例值 |
|-----------|---------|-------------------|--------|
| `<NUM>` | 纯数字 | `var_num_1`, `var_num_2`... | 404, 500, 12345 |
| `<ID>` | 字母数字组合 | `var_id_1`, `var_id_2`... | item_001, user_abc |
| `<IP>` | IP 地址格式 | `var_ip_1` | 192.168.1.100 |
| `<PATH>` | 文件路径格式 | `var_path_1` | /data/texture.png |
| `<TIME>` | 时间戳格式 | `var_time_1` | 2026-01-27 10:00:00 |
| `<*>` | 通用匹配 | `var_1`, `var_2`... | 任意字符串 |

### 2.2 维度命名

系统自动为每个变量字段生成维度名称，用户可以自定义重命名：

```
签名：ERROR: Failed to load item <*>, code: <NUM>

自动生成维度：
├── var_1 (第一个 <*>)
└── var_num_1 (第一个 <NUM>)

用户重命名后：
├── item_id (更易理解)
└── error_code (更易理解)
```

---

## 三、核心功能

### 3.1 维度分布统计

对签名中的每个变量字段，统计其实际值的分布：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  签名: ERROR: Failed to load item <item_id>, code: <error_code>         │
│  总匹配日志数: 125,000 条                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  维度: item_id                           维度: error_code               │
│  ┌─────────────────────────────┐        ┌─────────────────────────────┐│
│  │ 值              数量    占比 │        │ 值         数量       占比  ││
│  ├─────────────────────────────┤        ├─────────────────────────────┤│
│  │ item_weapon_001  45,000  36%│        │ 404       87,500       70% ││
│  │ item_armor_002   30,000  24%│        │ 500       25,000       20% ││
│  │ item_helmet_003  18,750  15%│        │ 503       12,500       10% ││
│  │ item_shield_004  12,500  10%│        │                            ││
│  │ item_boots_005    8,750   7%│        │                            ││
│  │ 其他 (156个值)   10,000   8%│        │                            ││
│  └─────────────────────────────┘        └─────────────────────────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 维度下钻

选中某个维度值后，进一步分析：

```
下钻路径：签名 → item_id = "item_weapon_001" → 查看该资源的详细情况

┌─────────────────────────────────────────────────────────────────────────┐
│  下钻分析: item_id = "item_weapon_001"                                  │
│  匹配日志数: 45,000 条 (占签名总量 36%)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  在 item_id = "item_weapon_001" 的日志中：                              │
│                                                                         │
│  error_code 分布:                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 404    38,000 条   84% ████████████████████                     │   │
│  │ 500     5,000 条   11% ███                                      │   │
│  │ 503     2,000 条    5% █                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  时间趋势:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │     ▲                                                            │   │
│  │ 10k │              ╭────────────────╮                           │   │
│  │     │         ╭────╯                ╰────                       │   │
│  │  5k │    ╭────╯                                                 │   │
│  │     └────┴──────────────────────────────────────────► 时间       │   │
│  │         1/24    1/25    1/26    1/27                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  日志样本:                                                              │
│  • [10:00:01] ERROR: Failed to load item item_weapon_001, code: 404    │
│  • [10:00:15] ERROR: Failed to load item item_weapon_001, code: 404    │
│  • [10:00:32] ERROR: Failed to load item item_weapon_001, code: 500    │
│                                                                         │
│  [继续下钻 error_code=404]  [导出日志]  [返回上级]                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 多维交叉分析

同时选择多个维度值，进行交叉筛选：

```
筛选条件：item_id = "item_weapon_001" AND error_code = "404"

┌─────────────────────────────────────────────────────────────────────────┐
│  交叉分析结果                                                           │
│  筛选: item_id = "item_weapon_001" AND error_code = "404"              │
│  匹配日志数: 38,000 条                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  这 38,000 条日志的分布：                                               │
│                                                                         │
│  按时间分布:                       按小时分布:                          │
│  ┌─────────────────────┐          ┌─────────────────────┐              │
│  │ 1/27  25,000  66%   │          │ 14:00-15:00  8,000  │              │
│  │ 1/26  10,000  26%   │          │ 15:00-16:00  6,500  │              │
│  │ 1/25   3,000   8%   │          │ 16:00-17:00  5,200  │              │
│  └─────────────────────┘          │ ...                 │              │
│                                   └─────────────────────┘              │
│                                                                         │
│  结论: 该资源的 404 错误集中在 1/27，可能与当天的版本发布相关            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 维度趋势分析

查看某个维度值随时间的变化趋势：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  维度趋势: item_id 各值随时间变化                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│     ▲ 日志数量                                                          │
│     │                                                                   │
│ 15k │                              ╭── item_weapon_001 (突增!)         │
│     │                         ╭───╯                                    │
│ 10k │    ╭── item_armor_002 ──╯                                        │
│     │ ───╯                                                              │
│  5k │ ─────────────────────────────── item_helmet_003 (稳定)           │
│     │                                                                   │
│     └───────────────────────────────────────────────────────► 时间      │
│           1/24      1/25      1/26      1/27                           │
│                                                                         │
│  异常检测: item_weapon_001 在 1/27 出现异常增长 (+300%)                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 四、操作流程

### 4.1 完整分析流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         维度分析操作流程                                 │
└─────────────────────────────────────────────────────────────────────────┘

  选择签名              查看维度              选择下钻              深入分析
     │                    │                    │                    │
     ▼                    ▼                    ▼                    ▼
┌──────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐
│ 从签名列表 │  ───►  │ 展示签名中 │  ───►  │ 点击某个  │  ───►  │ 查看该值  │
│ 选择一个  │        │ 所有变量  │        │ 维度值   │        │ 的详细   │
│ 签名     │        │ 字段分布  │        │          │        │ 分布     │
└──────────┘        └──────────┘        └──────────┘        └──────────┘
                                               │
                                               ▼
                                        ┌──────────┐
                                        │ 可继续   │
                                        │ 多级下钻 │
                                        └──────────┘
```

### 4.2 下钻层级示例

```
第一层：签名总览
├── 签名: ERROR: Failed to load <item_id>, code: <error_code>
├── 总日志数: 125,000 条
└── 变量字段: item_id, error_code

    │
    │ 点击 item_id 分布中的 "item_weapon_001"
    ▼

第二层：单维度下钻
├── 筛选条件: item_id = "item_weapon_001"
├── 匹配日志数: 45,000 条
└── 查看 error_code 在该筛选下的分布

    │
    │ 继续点击 error_code = "404"
    ▼

第三层：多维度交叉
├── 筛选条件: item_id = "item_weapon_001" AND error_code = "404"
├── 匹配日志数: 38,000 条
└── 查看时间分布、日志样本

    │
    │ 查看具体日志
    ▼

第四层：日志详情
└── 展示匹配的原始日志列表
```

---

## 五、界面设计

### 5.1 签名详情页 - 维度分析区

```
┌─────────────────────────────────────────────────────────────────────────┐
│  签名详情                                                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  签名模式:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ERROR: Failed to load item [<item_id>], code: [<error_code>]    │   │
│  │                            ──────────        ────────────       │   │
│  │                            可点击下钻         可点击下钻         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  维度分析    [item_id ▼]  [error_code]                    时间范围: 7天 │
│                                                                         │
│  当前选中维度: item_id                                                  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  值                              数量         占比      操作     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  item_weapon_001                 45,000       36%      [下钻]   │   │
│  │  item_armor_002                  30,000       24%      [下钻]   │   │
│  │  item_helmet_003                 18,750       15%      [下钻]   │   │
│  │  item_shield_004                 12,500       10%      [下钻]   │   │
│  │  item_boots_005                   8,750        7%      [下钻]   │   │
│  │  ──────────────────────────────────────────────────────────────│   │
│  │  显示更多 (共 161 个不同值)                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  可视化:  [柱状图]  [饼图]  [趋势图]                                     │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │         item_weapon_001 ████████████████████████████████ 36%    │   │
│  │         item_armor_002  ████████████████████            24%    │   │
│  │         item_helmet_003 ████████████                    15%    │   │
│  │         item_shield_004 ████████                        10%    │   │
│  │         item_boots_005  ██████                           7%    │   │
│  │         其他            ██████                           8%    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 下钻结果页

```
┌─────────────────────────────────────────────────────────────────────────┐
│  维度下钻                                                    [← 返回]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  当前筛选条件:                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ item_id = "item_weapon_001"                              [×清除] │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  匹配日志: 45,000 条 (占总量 36%)                                       │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  其他维度分布:                                                          │
│                                                                         │
│  error_code 分布:                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 404     38,000    84%  ████████████████████████████████  [下钻] │   │
│  │ 500      5,000    11%  ████                              [下钻] │   │
│  │ 503      2,000     5%  ██                                [下钻] │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  时间趋势:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │     ▲                                                            │   │
│  │ 20k │                                    ╭────╮                 │   │
│  │     │                              ╭────╯    │                 │   │
│  │ 10k │    ╭────────────────────────╯          ╰────             │   │
│  │     └────┴─────────────────────────────────────────► 时间       │   │
│  │         1/24    1/25    1/26    1/27                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────── │
│                                                                         │
│  日志样本 (共 45,000 条):                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ [2026-01-27 10:00:01] ERROR: Failed to load item item_weapon_001│   │
│  │ , code: 404                                                      │   │
│  │ ────────────────────────────────────────────────────────────────│   │
│  │ [2026-01-27 10:00:15] ERROR: Failed to load item item_weapon_001│   │
│  │ , code: 404                                                      │   │
│  │ ────────────────────────────────────────────────────────────────│   │
│  │ [2026-01-27 10:00:32] ERROR: Failed to load item item_weapon_001│   │
│  │ , code: 500                                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  [加载更多...]                                              [导出日志]  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 多维度筛选器

```
┌─────────────────────────────────────────────────────────────────────────┐
│  筛选条件                                                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│  │ item_id     │  │ error_code  │  │ + 添加条件  │                     │
│  │ ─────────── │  │ ─────────── │  └─────────────┘                     │
│  │ = ▼         │  │ = ▼         │                                      │
│  │ item_wea... │  │ 404         │                                      │
│  │         [×] │  │         [×] │                                      │
│  └─────────────┘  └─────────────┘                                      │
│                                                                         │
│  条件关系: [AND ▼]                         [应用筛选]  [清除全部]        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 六、典型使用场景

### 场景1：定位问题资源

```
背景：发现一个加载失败的签名，想知道是哪些资源出问题

操作路径：
1. 查看签名 "Failed to load <resource_path>"
2. 分析 resource_path 维度分布
3. 发现 "textures/hero_skin_003.png" 占 90%
4. 结论：这个资源文件可能损坏或路径错误
```

### 场景2：定位问题版本

```
背景：错误日志突增，想知道是不是新版本引入的

操作路径：
1. 查看签名总体趋势，确认 1/27 开始增长
2. 如果日志中有版本信息，按版本维度分析
3. 发现 v2.3.0 占 95%（1/27 上线）
4. 结论：v2.3.0 引入了这个问题
```

### 场景3：分析错误码分布

```
背景：想知道某个网络错误主要是什么原因

操作路径：
1. 查看签名 "Network error, code: <error_code>"
2. 分析 error_code 维度分布
3. 发现 10061 (连接拒绝) 占 60%，10060 (超时) 占 30%
4. 下钻 error_code=10061，查看时间分布
5. 发现集中在凌晨 2:00-4:00
6. 结论：可能是服务端维护期间的正常错误
```

### 场景4：交叉分析定位根因

```
背景：某个错误只在特定条件下出现

操作路径：
1. 查看签名 "Render failed, device: <device>, shader: <shader>"
2. 分析 device 维度：发现 "Mali-G76" 占 80%
3. 下钻 device="Mali-G76"，再看 shader 维度
4. 发现 "pbr_water" 占 95%
5. 结论：pbr_water 着色器在 Mali-G76 GPU 上有兼容性问题
```

---

## 七、数据结构设计

### 7.1 签名维度元数据

```
SignatureDimension {
  signature_id: string          // 签名ID
  dimension_index: number       // 变量在签名中的位置（第几个占位符）
  dimension_name: string        // 维度名称（可自定义）
  dimension_type: enum          // NUM, ID, IP, PATH, TIME, WILDCARD
  placeholder: string           // 原始占位符 <NUM>, <*> 等
  unique_values_count: number   // 不同值的数量
  sample_values: string[]       // 示例值（前10个）
}
```

### 7.2 维度统计数据

```
DimensionStatistics {
  signature_id: string
  dimension_name: string
  time_range: TimeRange
  total_count: number           // 总日志数
  value_distribution: [
    {
      value: string             // 维度值
      count: number             // 出现次数
      percentage: number        // 占比
      trend: number             // 趋势（环比变化）
    }
  ]
}
```

### 7.3 下钻查询请求

```
DrillDownQuery {
  signature_id: string
  filters: [                    // 筛选条件
    {
      dimension: string         // 维度名称
      operator: "=" | "!=" | "contains" | "regex"
      value: string | string[]  // 筛选值
    }
  ]
  group_by: string              // 要分析的维度
  time_range: TimeRange
  limit: number                 // 返回条数限制
}
```

---

## 八、功能边界

### 8.1 支持的能力

- ✅ 对签名中的变量字段进行分布统计
- ✅ 单维度下钻分析
- ✅ 多维度交叉筛选
- ✅ 维度值的时间趋势分析
- ✅ 下钻后查看原始日志样本
- ✅ 维度重命名

### 8.2 不支持的能力

- ❌ 对非签名变量的字段分析（需要先配置字段提取）
- ❌ 跨签名的维度关联分析
- ❌ 自定义聚合函数（目前只支持计数）

### 8.3 性能约束

| 约束项 | 限制 | 说明 |
|-------|------|------|
| 单维度最大不同值 | 10,000 | 超过后只展示 Top 10,000 |
| 下钻层级 | 5 层 | 最多支持 5 级下钻 |
| 时间范围 | 30 天 | 单次查询最大时间跨度 |
| 日志样本 | 1,000 条 | 下钻结果最多展示 1,000 条日志 |

---

## 九、总结

### 核心价值

```
签名中的变量字段
       │
       ▼
  维度分布统计  ───► 快速了解问题分布（哪些资源、哪些错误码）
       │
       ▼
    下钻分析    ───► 深入定位问题（某资源+某错误码的组合）
       │
       ▼
  原始日志查看  ───► 确认问题细节（具体的日志内容）
```

### 一句话总结

> **维度分析让聚类签名不仅仅是一个模式，而是一个可探索的数据入口。**

---

*文档版本: v1.0*  
*创建日期: 2026-01-27*
