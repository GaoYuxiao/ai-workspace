# 客户端日志智能分析产品方案

> 版本：v2.0  
> 更新日期：2026-01-27  
> 核心理念：以场景驱动，被动接收日志，智能发现问题

---

## 一、产品定位

### 1.1 核心约束

- **日志不可改变**：客户端日志是什么格式就是什么格式，平台只能被动接收
- **格式混杂**：同一份日志流中可能混合多种格式（Key:Value、纯文本、堆栈等）
- **用户是研发**：目标用户具备一定技术能力，可以理解正则、字段提取等概念

### 1.2 三大核心场景

| 场景 | 解决的问题 | 核心价值 |
|------|-----------|---------|
| **场景一：指标告警** | 我知道要监控什么，帮我盯着 | 已知问题的持续监控 |
| **场景二：日志聚类** | 我不知道会出什么问题，帮我发现 | 未知问题的主动发现 |
| **场景三：维度分析** | 发现问题后，帮我分析分布 | 问题根因的下钻定位 |

---

## 二、场景一：指标告警

> **适用情况**：用户明确知道要监控什么指标（如 FPS、支付成功率），需要持续监控并在异常时告警

### 2.1 场景描述

```
用户诉求：
"我想监控客户端的 FPS，当 FPS 低于 30 持续 5 分钟时，给我发告警"
"我想监控支付成功率，当成功率低于 95% 时告警"
```

### 2.2 核心流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         指标告警流程                                     │
└─────────────────────────────────────────────────────────────────────────┘

  日志接入             字段提取              指标配置              告警触发
     │                   │                    │                    │
     ▼                   ▼                    ▼                    ▼
┌──────────┐       ┌──────────┐        ┌──────────┐        ┌──────────┐
│ 原始日志  │ ───►  │ 配置提取  │  ───►  │ 定义指标  │  ───►  │ 阈值判断  │
│          │       │ 规则     │        │ 和阈值   │        │ 触发告警  │
└──────────┘       └──────────┘        └──────────┘        └──────────┘
```

### 2.3 字段提取方式

由于日志格式不可改变，用户需要配置"提取规则"来从日志中抽取字段：

| 提取方式 | 说明 | 适用场景 | 示例 |
|---------|------|---------|------|
| **正则提取** | 用户编写正则表达式 | 灵活，适合研发用户 | `FPS:\s*(\d+)` 提取 FPS 值 |
| **分隔符提取** | 按分隔符拆分取第N个 | Key:Value 格式日志 | 按空格拆分，取第2个字段 |
| **JSON 路径** | 按 JSON 路径提取 | JSON 格式日志 | `$.performance.fps` |
| **Grok 模式** | 预置模式组合 | 常见日志格式 | `%{NUMBER:fps}` |

**配置示例**：
```
日志样本：[2026-01-27 10:00:01] PERF FPS: 45, Memory: 1024MB

提取规则：
├── 字段名: fps
│   └── 正则: FPS:\s*(\d+)
├── 字段名: memory_mb
│   └── 正则: Memory:\s*(\d+)
└── 字段名: timestamp
    └── 正则: \[(.*?)\]
```

### 2.4 指标定义

基于提取的字段，定义监控指标：

| 指标类型 | 说明 | 示例 |
|---------|------|------|
| **原始值** | 直接使用字段值 | fps 字段的值 |
| **计数** | 统计日志条数 | 错误日志的数量 |
| **聚合计算** | 均值/求和/分位数 | 平均 FPS、P99 延迟 |
| **比率计算** | 两个指标相除 | 成功数 / 总数 = 成功率 |

### 2.5 告警规则

| 规则类型 | 说明 | 示例 |
|---------|------|------|
| **静态阈值** | 超过/低于固定值 | FPS < 30 告警 |
| **同比环比** | 与历史对比 | 比昨日同时刻下降 20% |
| **趋势检测** | 持续上升/下降 | 连续 5 分钟下降 |
| **无数据告警** | 预期日志未出现 | 心跳日志 10 分钟未出现 |

---

## 三、场景二：日志聚类

> **适用情况**：用户不知道会出什么问题，希望平台自动发现异常日志模式

### 3.1 场景描述

```
用户诉求：
"客户端会上报各种错误日志，我想知道有哪些类型的错误"
"新版本上线后，有没有出现以前没见过的报错"
"某个错误突然变多了，帮我发现并通知我"
```

### 3.2 日志聚类的本质

将海量日志**收敛**为有限的**签名/模式**：

```
原始日志（10万条）                      聚类签名（50个）
─────────────────────                  ─────────────────
ERROR: Connection failed, code: 10061   
ERROR: Connection failed, code: 10060   ──► 签名A: ERROR: Connection failed, code: <NUM>
ERROR: Connection failed, code: 10054        (出现 8000 次)

NullPointerException at Player.java:125
NullPointerException at Player.java:130  ──► 签名B: NullPointerException at Player.java:<NUM>
NullPointerException at Player.java:142      (出现 3000 次)

FileNotFound: texture_001.png
FileNotFound: texture_002.png            ──► 签名C: FileNotFound: texture_<*>.png
FileNotFound: model_abc.png                  (出现 1500 次)
```

### 3.3 日志处理方式

针对不同的日志特征，提供三种处理方式：

#### 方式一：单行独立聚类（推荐默认）

**适用场景**：日志格式不确定，或每行是独立的日志

```
处理逻辑：
├── 每一行作为一条独立的日志
├── 直接进行聚类，生成签名
└── 通过"关联分析"发现经常同时出现的签名
```

**优点**：
- 简单可靠，不会合并出错
- 对任意格式的日志都适用

**关联分析示例**：
```
平台发现：
├── 签名A: "ERROR: NullPointerException"
├── 签名B: "    at com.game.Player.attack"
└── 签名C: "    at com.game.Battle.run"

这三个签名总是在 100ms 内同时出现 → 提示用户它们可能是同一个问题的堆栈
```

#### 方式二：多行合并后聚类

**适用场景**：日志中有明确的多行堆栈，且有可识别的日志头

```
处理逻辑：
├── 识别"日志头"模式（如时间戳开头、日志级别开头）
├── 不匹配日志头的行，合并到上一条日志
└── 合并后的完整日志再进行聚类
```

**启发式合并规则**：
```
以下情况视为"续行"，合并到上一条：
├── 以空格或 Tab 开头（缩进）
├── 以 "at " 开头（Java 堆栈）
├── 以 "Caused by:" 开头
├── 以 "File " 开头（Python traceback）
└── 不包含时间戳格式
```

**风险**：合并规则可能不准确，导致合并错误或漏合并

#### 方式三：用户自定义规则

**适用场景**：用户明确知道自己的日志格式

```
用户配置：
├── 日志处理模式: [单行 / 多行自动 / 多行自定义]
└── 多行首行正则: ^\[\d{4}-\d{2}-\d{2}    （可选）
```

### 3.4 签名生成规则

聚类算法自动识别日志中的**可变部分**，替换为占位符：

| 变量类型 | 识别规则 | 替换为 |
|---------|---------|-------|
| 数字 | 连续数字 | `<NUM>` |
| IP 地址 | IP 格式 | `<IP>` |
| 文件路径 | 路径格式 | `<PATH>` |
| 时间戳 | 日期时间格式 | `<TIME>` |
| UUID/长ID | 长字符串 | `<ID>` |
| 通用变量 | 其他变化部分 | `<*>` |

**示例**：
```
原始日志：
[2026-01-27 10:00:01] ERROR: Failed to load /data/textures/hero_001.png, retry: 3

生成签名：
[<TIME>] ERROR: Failed to load <PATH>, retry: <NUM>
```

### 3.5 核心能力

#### 能力1：新签名发现

```
触发条件：
├── 首次出现：从未见过的日志模式
├── 版本关联：新版本上线后出现的新签名
└── 设备关联：仅在特定机型出现的签名

推送内容：
┌─────────────────────────────────────────────────────────────┐
│ 🔔 发现新签名                                                │
├─────────────────────────────────────────────────────────────┤
│ 签名模式: [<TIME>] ERROR: Shader compile failed: <*>        │
│ 首次出现: 2026-01-27 14:30:00                               │
│ 已出现次数: 1,234                                            │
│ 关联版本: v2.3.0 (今日上线)                                  │
│                                                             │
│ 样本日志:                                                    │
│ • [14:30:01] ERROR: Shader compile failed: pbr_standard     │
│ • [14:30:15] ERROR: Shader compile failed: water_surface    │
│                                                             │
│ [查看详情] [标记为已知] [忽略]                                │
└─────────────────────────────────────────────────────────────┘
```

#### 能力2：签名频次监控

```
监控规则：
├── 频次突增：某签名出现次数比历史均值高 N 倍
├── 频次突降：预期出现的签名突然减少或消失
└── 占比变化：某签名占总错误日志的比例异常
```

#### 能力3：签名状态管理

```
签名生命周期：
                    
    ┌──────────┐     用户确认     ┌──────────┐
    │  新发现   │ ───────────────► │  已确认   │
    │          │                  │ (已知问题) │
    └────┬─────┘                  └─────┬────┘
         │                              │
         │ 用户忽略                      │ 问题修复
         ▼                              ▼
    ┌──────────┐                  ┌──────────┐
    │  已忽略   │                  │  已解决   │
    │ (无需关注) │                  │          │
    └──────────┘                  └──────────┘
```

---

## 四、场景三：维度分析

> **适用情况**：发现问题签名后，需要下钻分析具体分布，定位根因

### 4.1 场景描述

```
用户诉求：
"这个错误签名出现了 1 万次，我想知道是哪些设备上出现的"
"签名里有个 ItemID，我想看看是哪些 ItemID 出问题"
"这个问题是所有版本都有，还是只有新版本才有"
```

### 4.2 核心概念

签名中的 `<*>` 占位符，其实是有具体值的。维度分析就是对这些值进行统计：

```
签名：ERROR: Failed to load item <ID>, code: <NUM>

变量字段：
├── <ID> 的实际值分布
│   ├── item_001: 5000 次 (50%)
│   ├── item_002: 3000 次 (30%)
│   └── item_003: 2000 次 (20%)
│
└── <NUM> 的实际值分布
    ├── 404: 8000 次 (80%)
    ├── 500: 1500 次 (15%)
    └── 503: 500 次 (5%)
```

### 4.3 分析维度

#### 维度类型1：签名内变量

对签名中的占位符进行分析：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  签名: ERROR: Failed to load item <ID>, code: <NUM>                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  变量 <ID> 分布:                          变量 <NUM> 分布:              │
│  ┌─────────────────────────┐              ┌─────────────────────────┐  │
│  │ item_weapon_001   50%   │              │ 404    80% ████████     │  │
│  │ item_armor_002    30%   │              │ 500    15% ██           │  │
│  │ item_helmet_003   20%   │              │ 503     5% █            │  │
│  └─────────────────────────┘              └─────────────────────────┘  │
│                                                                         │
│  [下钻 item_weapon_001]  [下钻错误码 404]                               │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 维度类型2：日志上下文字段

如果日志本身包含维度信息（如设备、版本、用户ID），可以按这些维度分析：

```
分析维度：
├── 设备维度
│   ├── 按操作系统: iOS 60%, Android 40%
│   ├── 按机型: iPhone15 30%, Xiaomi14 25%, ...
│   └── 按网络: WiFi 70%, 4G 25%, 5G 5%
│
├── 版本维度
│   ├── v2.3.0: 8000 次 (80%)  ← 新版本占比异常高
│   ├── v2.2.0: 1500 次 (15%)
│   └── v2.1.0: 500 次 (5%)
│
└── 时间维度
    ├── 按小时分布: 高峰在 20:00-22:00
    └── 按日期趋势: 1月27日开始激增
```

### 4.4 下钻分析流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          下钻分析流程                                    │
└─────────────────────────────────────────────────────────────────────────┘

  签名总览              变量分布              二次下钻              日志详情
     │                    │                    │                    │
     ▼                    ▼                    ▼                    ▼
┌──────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐
│ 签名A     │  ───►  │ <ID> 分布 │  ───►  │ 选中某个  │  ───►  │ 查看原始  │
│ 出现1万次 │        │ Top 10   │        │ ID 再分析 │        │ 日志样本  │
└──────────┘        └──────────┘        └──────────┘        └──────────┘
                          │
                          ├── 按设备下钻
                          ├── 按版本下钻
                          └── 按时间下钻
```

### 4.5 典型分析场景

| 场景 | 分析路径 | 定位结果 |
|------|---------|---------|
| **定位问题资源** | 签名 → `<PATH>` 分布 → 发现 `hero_skin_003.png` 占 90% | 这个资源文件有问题 |
| **定位问题版本** | 签名 → 按版本分布 → 发现 v2.3.0 占 95% | 新版本引入的问题 |
| **定位问题机型** | 签名 → 按设备分布 → 发现某低端机占 80% | 兼容性问题 |
| **定位问题时间** | 签名 → 按时间分布 → 发现 14:00 后激增 | 可能与某次配置变更相关 |

---

## 五、三大场景协同工作

### 5.1 场景关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         三大场景协同                                     │
└─────────────────────────────────────────────────────────────────────────┘

                              日志流
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
         ┌───────────┐   ┌───────────┐   ┌───────────┐
         │ 场景一     │   │ 场景二     │   │ 场景三     │
         │ 指标告警   │   │ 日志聚类   │   │ 维度分析   │
         ├───────────┤   ├───────────┤   ├───────────┤
         │ 已知问题   │   │ 未知问题   │   │ 问题定位   │
         │ 持续监控   │   │ 主动发现   │   │ 根因分析   │
         └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
               │               │               │
               │               │               │
               ▼               ▼               ▼
         ┌─────────────────────────────────────────┐
         │                                         │
         │    聚类发现问题 ──► 配置为告警指标       │
         │                                         │
         │    告警触发 ──► 关联聚类签名 ──► 下钻分析 │
         │                                         │
         └─────────────────────────────────────────┘
```

### 5.2 典型工作流

**工作流1：从聚类发现到告警配置**

```
1. 日志聚类发现新签名：ERROR: Payment failed, code: <NUM>
2. 用户确认这是重要问题
3. 用户把签名中的 <NUM> = 500 配置为告警指标
4. 此后，只要出现 code: 500 的支付失败，就会触发告警
```

**工作流2：从告警到根因定位**

```
1. 指标告警触发：支付成功率下降到 85%
2. 平台自动关联同时段的聚类签名
3. 发现签名 "Payment timeout" 频次突增
4. 用户下钻分析：发现 90% 来自 Android 10 设备
5. 定位根因：某 Android 版本的网络兼容性问题
```

---

## 六、产品界面规划

### 6.1 模块结构

```
平台导航
├── 概览
│   ├── 核心指标大盘
│   ├── 活跃告警
│   └── 新发现签名
│
├── 指标告警
│   ├── 字段提取配置
│   ├── 指标定义
│   ├── 告警规则
│   └── 告警记录
│
├── 日志聚类
│   ├── 签名列表
│   │   ├── 新发现
│   │   ├── 已确认
│   │   └── 已忽略
│   ├── 签名详情
│   └── 签名监控规则
│
├── 维度分析
│   ├── 变量分布
│   ├── 设备分布
│   ├── 版本分布
│   └── 时间趋势
│
└── 日志检索
    ├── 全文搜索
    └── 按签名筛选
```

### 6.2 核心页面

#### 页面1：签名列表

```
┌─────────────────────────────────────────────────────────────────────────┐
│  日志聚类 > 签名列表                                    [新发现: 3]      │
├─────────────────────────────────────────────────────────────────────────┤
│  筛选: [全部▼] [状态▼] [时间范围▼]                    排序: [频次▼]     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🔴 SIG_001 (新发现)                                      5,234 次/小时 │
│  ERROR: Shader compile failed: <*>                                      │
│  首次出现: 今日 14:30  |  关联版本: v2.3.0                              │
│  [查看详情] [标记已知] [忽略]                                            │
│  ───────────────────────────────────────────────────────────────────── │
│  🟡 SIG_002 (已确认)                                      1,200 次/小时 │
│  Connection timeout to <IP>:<NUM>                                       │
│  首次出现: 7天前  |  趋势: ↑ 50%                                        │
│  [查看详情] [配置告警] [分析]                                            │
│  ───────────────────────────────────────────────────────────────────── │
│  ⚪ SIG_003 (已确认)                                        200 次/小时 │
│  Failed to load resource <PATH>                                         │
│  首次出现: 30天前  |  趋势: 稳定                                        │
│  [查看详情] [配置告警] [分析]                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 页面2：签名详情 + 维度分析

```
┌─────────────────────────────────────────────────────────────────────────┐
│  签名详情: SIG_001                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  签名模式: ERROR: Failed to load item <ID>, code: <NUM>                 │
│  状态: 已确认  |  首次出现: 2026-01-20  |  总计: 125,000 次             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  频次趋势                                                        │   │
│  │     ▲                                                            │   │
│  │  5k │                                    ╭──╮                    │   │
│  │     │                              ╭────╯  │                    │   │
│  │  2k │    ╭──────────────────────────╯       ╰────               │   │
│  │     └────┴─────────────────────────────────────────► 时间        │   │
│  │         1/20  1/21  1/22  1/23  1/24  1/25  1/26  1/27          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────┐  ┌─────────────────────────┐             │
│  │  变量 <ID> 分布          │  │  变量 <NUM> 分布         │             │
│  │  ─────────────────────  │  │  ─────────────────────  │             │
│  │  item_001    45% ████   │  │  404    70% ███████    │             │
│  │  item_002    30% ███    │  │  500    20% ██         │             │
│  │  item_003    15% ██     │  │  503    10% █          │             │
│  │  其他        10% █      │  │                        │             │
│  │  [展开全部]              │  │  [展开全部]             │             │
│  └─────────────────────────┘  └─────────────────────────┘             │
│                                                                         │
│  ┌─────────────────────────┐  ┌─────────────────────────┐             │
│  │  版本分布                │  │  设备分布                │             │
│  │  ─────────────────────  │  │  ─────────────────────  │             │
│  │  v2.3.0    80% ████████ │  │  iOS       55% ██████  │             │
│  │  v2.2.0    15% ██       │  │  Android   45% █████   │             │
│  │  v2.1.0     5% █        │  │                        │             │
│  │  [下钻 v2.3.0]           │  │  [下钻 iOS]             │             │
│  └─────────────────────────┘  └─────────────────────────┘             │
│                                                                         │
│  日志样本:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ [10:00:01] ERROR: Failed to load item item_001, code: 404       │   │
│  │ [10:00:15] ERROR: Failed to load item item_002, code: 500       │   │
│  │ [10:00:32] ERROR: Failed to load item item_001, code: 404       │   │
│  │ [查看更多...]                                                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [配置为告警]  [标记已解决]  [导出数据]                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 七、总结

### 三大场景对照表

| 维度 | 场景一：指标告警 | 场景二：日志聚类 | 场景三：维度分析 |
|------|----------------|----------------|----------------|
| **核心问题** | 我知道监控什么 | 我不知道会出什么问题 | 问题出在哪里 |
| **用户角色** | 主动配置 | 被动接收 | 主动下钻 |
| **输入** | 字段提取规则 + 阈值 | 原始日志流 | 聚类签名 |
| **输出** | 告警通知 | 签名列表 + 新签名推送 | 分布图表 + 日志样本 |
| **典型用法** | 监控 FPS < 30 | 发现新增的错误类型 | 分析错误来自哪个版本 |

### 核心价值

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│    指标告警        日志聚类         维度分析                             │
│       │              │               │                                  │
│       ▼              ▼               ▼                                  │
│   已知问题      未知问题         问题根因                               │
│   持续监控      主动发现         定位分析                               │
│       │              │               │                                  │
│       └──────────────┴───────────────┘                                  │
│                      │                                                  │
│                      ▼                                                  │
│              从被动查日志                                               │
│                   到                                                    │
│              主动收告警                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

*文档版本: v2.0*  
*更新日期: 2026-01-27*  
*基于产品讨论整理*
