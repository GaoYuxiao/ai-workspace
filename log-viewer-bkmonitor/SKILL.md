---
name: log-viewer-bkmonitor
description: 使用蓝鲸监控 bkmonitor-log 能力进行日志查询、分析与浏览。用于根据用户给定的业务(bk_biz_id)、索引集(index_set_id)和查询条件拉取日志结果，在结果过大时采用翻页策略，并在用户选定目标日志后，展示该日志前后约 10 条的上下文日志，帮助进行问题排查与根因分析。
---

# BKMonitor Log Viewer Skill

## 概览

本 Skill 让 Agent 能够通过 **bkmonitor-log 系列 MCP 工具** 来完成日志查询、翻页浏览以及目标日志前后 10 条上下文展示，适用于接口报错排查、慢请求定位、异常模式发现等日志分析场景。

典型触发语句示例：

- “帮我查某个接口最近 1 小时的错误日志，并支持翻页看更多”
- “根据这条日志，再把它前后 10 条日志也给我看看”
- “在这个索引集里用关键词 xxx 搜日志，结果太多时帮我分页慢慢看”

---

## 一、所需 MCP 工具与基本约束

本 Skill 假定 Agent 可使用以下 MCP 工具（命名以实际环境为准）：

- `mcp_bkmonitor-log_list_index_sets`
- `mcp_bkmonitor-log_get_index_set_fields`
- `mcp_bkmonitor-log_search_logs`

使用约束（需要严格遵守）：

- **时间范围不能超过 1 天**：如果用户给出的时间跨度 > 24 小时，应拆成多次查询，每次 ≤ 24 小时。
- `end_time`、`start_time` 必须 **动态计算为当前时间相关的 Unix 秒级时间戳**，不可写死常量。
- 单次查询返回 `limit` 默认建议 200～500 条；若用户未指定，建议使用 200。
- 当用户要求“下一页”、“上一页”、“从某个时间点继续看”时，通过 **调整时间窗口和/或内部偏移游标** 实现翻页，而不是一次拉取过多日志。

---

## 二、整体能力与交互流程

### 1. 支持的能力

- **日志检索**：基于业务 `bk_biz_id`、索引集 `index_set_id`、`query_string` 和时间范围进行查询。
- **结果翻页**：当日志量较大或用户希望“查看更多”时，提供稳定的翻页策略，不超出单次结果限制。
- **目标日志上下文展示**：在用户指定一条“目标日志”后，展示该日志前后各约 10 条日志（共 21 条以内），帮助理解上下文。

### 2. 与用户的关键参数约定

在首次检索前，优先向用户澄清：

- **业务 ID**：`bk_biz_id`
- **索引集 ID**：`index_set_id`
- **时间范围**：如“最近 1 小时/最近 30 分钟/某天某个时间段”，统一换算为 `[start_time, end_time]` 秒级 Unix 时间戳
- **过滤条件**：用于构造 `query_string`，例如：
  - 关键字：错误码、请求路径、user_id 等
  - 日志级别：`level:ERROR`、`status:500 AND path:/api/*` 等
- **每页条数（可选）**：如用户未指定，默认 `page_size = 200`

---

## 三、日志查询与翻页策略

### 1. 首次查询步骤

1. **确认时间窗口在 24 小时内**；否则切成多段逐段查询。
2. 调用 `mcp_bkmonitor-log_search_logs`：
   - `bk_biz_id`: 用户提供
   - `index_set_id`: 用户提供
   - `query_string`: 基于用户给出的过滤条件拼接
   - `end_time`: 当前时间戳或用户指定结束时间
   - `start_time`: `end_time - time_window`（例如最近 1 小时）
   - `limit`: 用户指定的 `page_size` 或默认 200
3. 要求服务端对结果按时间升序或降序统一排序，并在 Agent 内部记录：
   - 当前页日志列表
   - 本页第一条和最后一条日志的时间戳
   - 用户可见索引（例如 1～N 编号）

向用户简要展示：

- 总体命中数量（如果接口有返回）
- 当前页的起止时间和条数
- 默认展示前若干条，并说明可通过“下一页/上一页/跳转到第 N 页”等指令翻页。

### 2. 翻页策略（核心）

当用户说“下一页 / 再往后看一些 / more logs”时：

1. 读取当前页最后一条日志的时间戳 `last_ts`。
2. 将下一次查询的时间窗口起点设置为：  
   \(\text{next\_start\_time} = last\_ts + 1\) 秒（防止重复）。
3. `end_time` 保持不变（如果用户给的是固定结束时间）或者设为“当前时间”。
4. 再次调用 `mcp_bkmonitor-log_search_logs`，使用同一 `query_string` 和 `limit = page_size`。
5. 将新结果作为下一页，并更新内部“当前页”指针。

当用户说“上一页”时，如果需要，可以在内部维护一个 **简易的页缓存列表**（最近若干页的结果和时间边界），从缓存中回退，而不是重新查询；若无缓存，可提示用户“暂不支持直接跳回更早的上一页，请指定新的时间范围或目标时间点重新查询”。

### 3. 超长时间范围的分段策略

若用户指定的时间范围超过 24 小时：

1. 按 24 小时一段（或更细）将原始 `[start_time, end_time]` 切分为多个子区间。
2. **只先查询最新的一段**（最接近当前时间），将结果作为第一页。
3. 当用户继续“往前翻页”且当前子区间已经耗尽时，再自动切换到更早的子区间继续查询。

---

## 四、目标日志前后 10 条上下文展示

本功能在用户“点中”一条目标日志后触发，常见指令：

- “以第 25 条日志为中心，给我看前后 10 条”
- “就这条 500 错误日志，把它上下文再展开一下”

### 1. 在当前页即可满足的情况

前提：目标日志所在页已经在内存中。

1. 用户通过“第 N 条”、“某条日志的唯一标识（如 log_id）”或直接引用上一条消息中的日志文本来指定目标日志。
2. 在当前页数组中找到目标日志的索引 `i`。
3. 计算需要展示的区间：
   - `start = max(0, i - 10)`
   - `end = min(len(page_logs) - 1, i + 10)`
4. 将 `page_logs[start:end+1]` 依时间顺序返回给用户，并在输出中清晰标记哪一条是“目标日志”（例如加前缀或高亮）。

### 2. 需跨页或重新查询的情况

如果目标日志不在当前缓存页内，或者它附近的前/后 10 条分布在其他时间段：

1. 尽量获取目标日志的 **时间戳 `target_ts`** 和（如果有）唯一 ID。
2. 以该时间戳为中心构造一个 **小时间窗口**：
   - `ctx_start = target_ts - Δ`
   - `ctx_end = target_ts + Δ`
   - 其中 Δ 可根据日志密度估计，比如 5～15 分钟，或由用户指定。
3. 调用 `mcp_bkmonitor-log_search_logs`，参数：
   - 同一 `bk_biz_id`、`index_set_id`、`query_string`
   - `start_time = ctx_start`
   - `end_time = ctx_end`
   - `limit` 可适当放宽，例如 500，以确保能覆盖前后 10 条。
4. 将结果按照时间排序，在数组中找到最贴近 `target_ts` 的那一条（或者通过唯一 ID 精确匹配）。
5. 再按“当前页情况”中的逻辑，从结果中选择前后最多各 10 条返回给用户。

要在回答中明确说明：

- 总共查询到了多少条上下文日志
- 实际返回了多少条（<= 21）
- 当前这组日志的起止时间

---

## 五、与用户的交互建议

- **主动确认关键信息**：在第一次查询前，若用户未给出 `bk_biz_id` 或 `index_set_id`，需要先询问，而不是盲目假设。
- **解释分页行为**：在结果有限制时，说明“本次只展示前 N 条，如需查看更多可说‘下一页’或指定时间点继续看”。
- **强调时间限制**：当用户时间跨度过大时，提示“单次查询最多支持 24 小时，将从最近一段开始查询，可逐步往前翻页”。
- **上下文展示时高亮目标日志**：在呈现前后 10 条时，使用清晰的标记（如“→ 目标日志”）帮助用户定位。

---

## Resources

本 Skill 当前只需要简洁的说明文档，不强依赖额外脚本与资产。可按实际需求扩展：

### scripts/
如后续需要为日志处理封装通用脚本（例如本地解析、脱敏、格式化展示），可以在此目录新增 Python/Bash 脚本，并在上文中注明使用方式。

### references/
如需要补充索引集规范、常用 `query_string` 模板或告警排查手册，可放在此目录，并在说明主体中引用。

### assets/
如需要定义固定的展示模板、示意图片或文档示例，可放于此目录，供回答中引用或复制。

---

**不需要的目录可以删除。** 当前保留默认结构，便于后续扩展。
