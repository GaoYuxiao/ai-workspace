# RUM 应用接入 - 产品需求文档

## 文档信息

| 属性 | 内容 |
|------|------|
| 文档版本 | v2.0 |
| 创建日期 | 2026-02-05 |
| 最后更新 | 2026-02-05 |
| 文档状态 | 评审中 |
| 产品模块 | RUM（Real User Monitoring）- 应用接入 |
| 原型文件 | [index.html](./index.html) |

---

## 一、产品概述

### 1.1 背景与目标

RUM（Real User Monitoring，真实用户监控）是前端性能监控的核心能力。本文档定义了 RUM 应用接入模块的功能需求，帮助用户完成应用创建、SDK 接入、数据采集配置等操作。

**核心目标：**
- 提供简洁的应用创建与管理流程
- 支持灵活的数据采集与采样配置
- 实现 URL 聚合与数据过滤能力
- 建立完善的阈值告警与体验评分体系

### 1.2 目标用户

| 用户角色 | 使用场景 |
|----------|----------|
| 前端开发工程师 | 接入 SDK、配置采集项、查看错误 |
| 运维/SRE 工程师 | 配置告警规则、监控应用状态 |
| 产品经理 | 查看用户体验评分、分析性能数据 |
| 技术负责人 | 管理应用配置、设置阈值标准 |

### 1.3 产品架构

```
RUM 应用接入
├── 应用列表（列表/搜索/筛选）
└── 应用配置（7 个功能 Tab）
    ├── 基本信息
    ├── SDK 接入
    ├── 数据采集
    ├── 页面规则
    ├── 阈值告警
    ├── 体验评分
    └── 高级设置
```

---

## 二、功能模块详述

### 2.1 应用列表

#### 2.1.1 功能说明

应用列表是 RUM 模块的入口页面，展示当前业务下的所有应用，支持搜索、筛选和管理操作。

#### 2.1.2 业务上下文

- 用户在平台中已选择业务后进入应用管理
- 页面顶部显示当前业务标识，如 `[2] 蓝鲸`
- 新建应用自动归属当前业务，无需额外选择

#### 2.1.3 列表字段

| 字段 | 说明 |
|------|------|
| 应用名称 | 显示应用名称和域名/包名 |
| 类型 | Web / iOS / Android / 小程序 |
| Token | 应用 Token（脱敏显示） |
| 状态 | 已启用 / 已停用 |
| 负责人 | 应用负责人列表 |
| 更新时间 | 最后修改时间 |
| 操作 | 配置、删除 |

#### 2.1.4 筛选条件

- 应用名称（模糊搜索）
- 应用类型（下拉选择）
- 应用状态（下拉选择）

#### 2.1.5 交互说明

1. **点击行**：进入应用配置页
2. **新建应用**：打开右侧抽屉表单
3. **删除应用**：二次确认弹窗，提示数据不可恢复

---

### 2.2 新建应用

#### 2.2.1 功能说明

通过侧滑抽屉表单创建新应用，创建成功后自动跳转到 SDK 接入页面。

#### 2.2.2 表单字段

| 字段 | 类型 | 必填 | 校验规则 |
|------|------|------|----------|
| 应用名称 | 文本输入 | 是 | 2-64 字符 |
| 应用别名 | 文本输入 | 否 | 英文/数字/下划线，2-32 字符 |
| 应用类型 | 单选卡片 | 是 | Web / iOS / Android / 小程序 |
| 负责人 | 人员选择器 | 是 | 至少 1 人 |
| 域名白名单 | 多行文本 | 是 | 每行一个域名，支持通配符 |
| 应用描述 | 多行文本 | 否 | 最多 500 字符 |

#### 2.2.3 特殊说明

- 表单顶部提示当前业务归属
- 应用 Token 创建后自动生成
- 应用类型创建后不可修改

---

### 2.3 基本信息

#### 2.3.1 功能说明

查看和编辑应用的基本属性信息。

#### 2.3.2 页面布局

**头部信息区：**
- 应用图标（根据类型显示）
- 应用名称
- 应用类型标签
- Token（可复制）
- 状态标签
- 重置 Token 按钮

**表单区：**
- 应用名称（可编辑）
- 应用别名（可编辑）
- 应用类型（只读）
- 负责人（可编辑）
- 域名白名单（可编辑）
- 应用状态（启用/停用）
- 应用描述（可编辑）

---

### 2.4 SDK 接入

#### 2.4.1 功能说明

提供 SDK 接入指引，帮助用户快速将 RUM SDK 集成到应用中。

#### 2.4.2 接入流程（步骤式引导）

**步骤 1：选择接入方式**

| 方式 | 说明 | 适用场景 |
|------|------|----------|
| CDN Script | 通过 `<script>` 标签引入 | 快速接入，无构建工具项目 |
| NPM 包 | 通过包管理器安装 | 现代前端工程项目 |

**步骤 2：配置选项**

| 配置项 | 类型 | 默认值 |
|--------|------|--------|
| 应用版本 | 文本输入 | 1.0.0 |
| 环境标识 | 下拉选择 | production |
| 采样率 | 数字输入 | 100% |
| 采集项开关 | 复选框组 | 全部开启 |

**步骤 3：复制代码**

根据配置动态生成可复制的初始化代码片段。

**步骤 4：验证接入**

提供「检测数据上报」按钮，检测成功后显示绿色提示。

#### 2.4.3 多环境配置

支持配置多个环境（production / staging / testing / development），每个环境可独立配置采样率。

| 字段 | 说明 |
|------|------|
| 环境标识 | 环境名称 |
| 采样率 | 该环境的采样比例 |
| 操作 | 编辑、删除 |

---

### 2.5 数据采集

#### 2.5.1 功能说明

控制 SDK 采集的数据类型，每个采集项支持独立的开关和采样率配置。

#### 2.5.2 采集项列表

| 采集项 | 说明 | 默认开关 | 默认采样率 |
|--------|------|----------|------------|
| 页面访问 | PV、UV、停留时长 | 开启 | 100% |
| Web Vitals | LCP、FID、CLS、INP、TTFB、FCP | 开启 | 100% |
| JS 错误 | JavaScript 运行时错误、Promise 异常 | 开启 | 100%（建议） |
| 资源加载 | 静态资源加载性能 | 开启 | 50% |
| API 请求 | XHR/Fetch 请求监控 | 开启 | 100% |
| 长任务 | Long Task 监控（>50ms） | 开启 | 50% |
| 会话回放 | Session Replay 录制 | 关闭 | 0% |

#### 2.5.3 API 请求详细配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 采集请求头 | 开关 | 关闭 | 是否采集请求头信息 |
| 采集响应头 | 开关 | 关闭 | 是否采集响应头信息 |
| 采集请求体 | 开关 | 关闭 | 需配合脱敏规则使用 |
| 采集响应体 | 开关 | 关闭 | 需配合脱敏规则使用 |
| 慢请求阈值 | 数字输入 | 3000ms | 超过该时长标记为慢请求 |
| 请求体大小限制 | 数字输入 | 10KB | 超过该大小不采集 |

#### 2.5.4 界面设计

每个采集项以卡片形式展示，包含：
- 左侧：图标 + 名称 + 描述
- 右侧：采样率输入框 + 开关

---

### 2.6 页面规则

#### 2.6.1 功能说明

配置 URL 聚合规则和数据过滤规则，提高数据分析质量。

#### 2.6.2 页面分组规则

**目的：** 将动态 URL 聚合为统一的页面名称，解决数据分散问题。

**示例：**
```
原始 URL                          聚合后
/user/12345/profile      →      /user/:number/profile
/order/abc123/detail     →      /order/:id/detail
```

**2.6.2.1 自动参数化**

| 规则 | 说明 | 示例 | 默认 |
|------|------|------|------|
| 纯数字参数化 | 将纯数字替换为 `:number` | /user/12345 → /user/:number | 开启 |
| UUID 参数化 | 将 UUID 替换为 `:uuid` | /doc/a1b2-c3d4-... → /doc/:uuid | 开启 |
| Hash ID 参数化 | 将 Hash ID 替换为 `:id` | /order/abc123xyz → /order/:id | 开启 |
| 忽略所有 Query 参数 | Query 参数不参与分组 | ?page=1&size=10 忽略 | 关闭 |

**2.6.2.2 自定义分组规则**

用户可自定义 URL 匹配模式和页面名称映射：

| 字段 | 说明 |
|------|------|
| URL 匹配模式 | 支持通配符的 URL 模式 |
| 页面名称 | 聚合后显示的页面名称 |
| 操作 | 编辑、删除 |

**匹配语法：**
- `*` - 匹配单段路径
- `**` - 匹配多段路径
- `?key=*` - 匹配指定参数

**2.6.2.3 Query 参数处理**

| 配置项 | 选项 |
|--------|------|
| 参数处理策略 | 全部忽略 / 白名单模式 / 黑名单模式 |
| 参与分组的参数 | 标签列表（可添加/删除） |
| 需要脱敏的参数 | 标签列表（如 token、password） |

#### 2.6.3 过滤规则

**2.6.3.1 URL 过滤规则**

| 字段 | 选项 |
|------|------|
| 过滤类型 | 排除 / 仅包含 |
| 匹配模式 | 前缀匹配 / 精确匹配 / 正则匹配 |
| URL 规则 | 文本输入 |

**常用规则：**
- 排除 `/health*`（健康检查）
- 排除 `/api/rum/report*`（RUM 上报接口）

**2.6.3.2 错误过滤规则**

| 字段 | 选项 |
|------|------|
| 过滤维度 | 错误消息 / 错误类型 / 来源文件 |
| 匹配模式 | 包含 / 不包含 / 正则匹配 |
| 规则内容 | 文本输入 |

**常用规则：**
- `Script error.`（跨域脚本错误）
- `ResizeObserver loop`（ResizeObserver 警告）
- `chrome-extension://`（浏览器插件错误）

**2.6.3.3 API 请求过滤规则**

| 字段 | 选项 |
|------|------|
| 过滤类型 | 排除 / 仅包含 |
| 匹配模式 | URL 前缀 / URL 正则 |
| URL 规则 | 文本输入 |

**常用规则：**
- 排除 `/api/heartbeat`（心跳接口）
- 排除 `/api/ping`（存活检测）

---

### 2.7 阈值告警

#### 2.7.1 功能说明

定义性能指标和业务指标的阈值标准，配置告警规则。

#### 2.7.2 Web Vitals 阈值配置

基于 Google Web Vitals 标准，支持自定义调整：

| 指标 | 良好 (Good) | 需改进 | 差 (Poor) | 单位 |
|------|-------------|--------|-----------|------|
| LCP | ≤ 2500 | ≤ 4000 | > 4000 | ms |
| FID | ≤ 100 | ≤ 300 | > 300 | ms |
| CLS | ≤ 0.1 | ≤ 0.25 | > 0.25 | - |
| INP | ≤ 200 | ≤ 500 | > 500 | ms |
| TTFB | ≤ 800 | ≤ 1800 | > 1800 | ms |
| FCP | ≤ 1800 | ≤ 3000 | > 3000 | ms |

#### 2.7.3 业务阈值配置

| 指标 | 警告阈值 | 严重阈值 | 计算说明 |
|------|----------|----------|----------|
| JS 错误率 | 1% | 5% | 错误 PV / 总 PV |
| API 失败率 | 1% | 5% | 失败请求 / 总请求 |
| 资源加载失败率 | 5% | 10% | 失败资源 / 总资源 |
| 慢请求占比 | 5% | 15% | 慢请求 / 总请求 |

#### 2.7.4 告警规则配置

**告警规则列表字段：**

| 字段 | 说明 |
|------|------|
| 规则名称 | 告警规则名称 |
| 监控指标 | 监控的指标类型 |
| 触发条件 | 阈值和持续时间 |
| 告警级别 | 警告 / 严重 |
| 通知渠道 | 企业微信 / 邮件 / 短信 |
| 状态 | 已启用 / 已停用 |
| 操作 | 编辑、删除 |

**新建告警规则：**
- 点击「新建告警规则」按钮
- 配置监控指标、触发条件、通知渠道

---

### 2.8 体验评分

#### 2.8.1 功能说明

配置用户体验评分标准，包括 Apdex 和综合评分权重。

#### 2.8.2 Apdex 配置

**配置项：**

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| 页面加载满意阈值 T | 数字输入 | 2000ms | 页面加载 Apdex 阈值 |
| API 请求满意阈值 T | 数字输入 | 500ms | API 请求 Apdex 阈值 |

**Apdex 计算规则：**
- 满意 (Satisfied)：响应时间 ≤ T
- 可容忍 (Tolerating)：T < 响应时间 ≤ 4T
- 不满意 (Frustrated)：响应时间 > 4T
- 公式：Apdex = (满意数 + 可容忍数 × 0.5) / 总样本数

#### 2.8.3 综合评分权重配置

| 维度 | 默认权重 | 计算依据 |
|------|----------|----------|
| 页面性能 | 40% | Web Vitals 综合得分 |
| 稳定性 | 30% | JS 错误率、API 成功率 |
| 可用性 | 20% | 资源加载成功率 |
| 交互体验 | 10% | FID、INP、长任务占比 |

**权重配置：**
- 通过滑块调整各维度权重
- 权重合计必须等于 100%

#### 2.8.4 评分等级定义

| 评分区间 | 等级 | 颜色标识 |
|----------|------|----------|
| 90 - 100 | 优秀 | 绿色 |
| 75 - 89 | 良好 | 蓝色 |
| 60 - 74 | 一般 | 黄色 |
| 0 - 59 | 较差 | 红色 |

---

### 2.9 高级设置

#### 2.9.1 Source Map 管理

**功能说明：**
上传 Source Map 文件用于错误堆栈还原，方便错误定位。

**配置项：**
- 开启 Source Map 解析（开关）
- 上传 Source Map（按钮）

**Source Map 列表：**

| 字段 | 说明 |
|------|------|
| 版本号 | 应用版本 |
| 文件名 | Source Map 文件名 |
| 文件大小 | 文件大小 |
| 上传时间 | 上传时间 |
| 操作 | 下载、删除 |

**CI/CD 自动上传：**
提供 curl 命令示例，支持在构建流程中自动上传。

#### 2.9.2 数据保留策略（P2）

| 数据类型 | 默认保留期 |
|----------|------------|
| 原始明细数据 | 7 天 |
| 聚合统计数据 | 90 天 |

---

## 三、交互规范

### 3.1 页面导航

- 顶部导航：平台 Logo、业务选择器、功能菜单
- 面包屑导航：应用管理 > 应用名称
- Tab 导航：7 个功能 Tab 切换

### 3.2 表单交互

- 必填字段标注红色星号
- 实时校验，错误时输入框边框变红
- 保存按钮在底部固定区域

### 3.3 列表交互

- 行悬停高亮
- 点击行进入详情
- 操作按钮在行尾

### 3.4 弹窗交互

- 新建应用：右侧滑出抽屉
- 删除确认：居中弹窗，需二次确认
- 告警规则编辑：右侧滑出抽屉

---

## 四、数据模型

### 4.1 应用配置数据结构

```json
{
  "id": 1,
  "app_token": "rum_xxxxxxxxxxxxxxxx",
  "app_name": "官网首页",
  "app_alias": "homepage",
  "app_type": "web",
  "bk_biz_id": 2,
  "owners": ["admin", "dev"],
  "domain_whitelist": ["*.example.com", "localhost"],
  "status": "enabled",
  "config": {
    "collection": {
      "page_view": { "enabled": true, "sample_rate": 100 },
      "web_vitals": { "enabled": true, "sample_rate": 100 },
      "js_error": { "enabled": true, "sample_rate": 100 },
      "resource": { "enabled": true, "sample_rate": 50 },
      "api_request": {
        "enabled": true,
        "sample_rate": 100,
        "collect_request_headers": false,
        "collect_response_headers": false,
        "collect_request_body": false,
        "collect_response_body": false,
        "slow_request_threshold": 3000,
        "body_size_limit": 10240
      },
      "long_task": { "enabled": true, "sample_rate": 50 },
      "session_replay": { "enabled": false, "sample_rate": 0 }
    },
    "page_rules": {
      "auto_parameterize": {
        "number": true,
        "uuid": true,
        "hash_id": true,
        "ignore_query": false
      },
      "custom_rules": [
        { "pattern": "/user/*/profile", "name": "用户详情页" },
        { "pattern": "/order/*/detail", "name": "订单详情页" }
      ],
      "query_params": {
        "mode": "ignore_all",
        "whitelist": ["tab", "type"],
        "sensitive": ["token", "password"]
      }
    },
    "filters": {
      "url_rules": [
        { "type": "exclude", "match": "prefix", "value": "/health" }
      ],
      "error_rules": [
        { "field": "message", "match": "contains", "value": "Script error." }
      ],
      "api_rules": [
        { "type": "exclude", "match": "prefix", "value": "/api/heartbeat" }
      ]
    },
    "threshold": {
      "web_vitals": {
        "lcp": { "good": 2500, "poor": 4000 },
        "fid": { "good": 100, "poor": 300 },
        "cls": { "good": 0.1, "poor": 0.25 },
        "inp": { "good": 200, "poor": 500 },
        "ttfb": { "good": 800, "poor": 1800 },
        "fcp": { "good": 1800, "poor": 3000 }
      },
      "business": {
        "js_error_rate": { "warning": 1, "critical": 5 },
        "api_error_rate": { "warning": 1, "critical": 5 },
        "resource_error_rate": { "warning": 5, "critical": 10 },
        "slow_request_rate": { "warning": 5, "critical": 15 }
      }
    },
    "scoring": {
      "apdex": {
        "page_threshold": 2000,
        "api_threshold": 500
      },
      "weights": {
        "performance": 40,
        "stability": 30,
        "availability": 20,
        "interaction": 10
      }
    }
  }
}
```

---

## 五、接口设计

### 5.1 应用管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 应用列表 | GET | `/api/rum/apps/` | 获取应用列表 |
| 创建应用 | POST | `/api/rum/apps/` | 创建新应用 |
| 应用详情 | GET | `/api/rum/apps/{id}/` | 获取应用配置 |
| 更新应用 | PUT | `/api/rum/apps/{id}/` | 更新应用配置 |
| 删除应用 | DELETE | `/api/rum/apps/{id}/` | 删除应用 |
| 重置 Token | POST | `/api/rum/apps/{id}/reset_token/` | 重置 Token |
| 检测上报 | GET | `/api/rum/apps/{id}/detect/` | 检测数据上报 |

### 5.2 Source Map 接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 列表 | GET | `/api/rum/apps/{id}/sourcemaps/` | 获取列表 |
| 上传 | POST | `/api/rum/apps/{id}/sourcemaps/` | 上传文件 |
| 下载 | GET | `/api/rum/apps/{id}/sourcemaps/{sid}/` | 下载文件 |
| 删除 | DELETE | `/api/rum/apps/{id}/sourcemaps/{sid}/` | 删除文件 |

### 5.3 告警规则接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 规则列表 | GET | `/api/rum/apps/{id}/alerts/` | 获取告警规则 |
| 创建规则 | POST | `/api/rum/apps/{id}/alerts/` | 创建告警规则 |
| 更新规则 | PUT | `/api/rum/apps/{id}/alerts/{aid}/` | 更新告警规则 |
| 删除规则 | DELETE | `/api/rum/apps/{id}/alerts/{aid}/` | 删除告警规则 |

---

## 六、非功能性需求

### 6.1 性能要求

| 指标 | 要求 |
|------|------|
| 应用列表加载 | ≤ 500ms |
| 配置保存响应 | ≤ 1s |
| SDK 接入验证 | ≤ 30s 超时 |
| Source Map 上传 | 单文件 ≤ 50MB |

### 6.2 安全要求

| 要求 | 说明 |
|------|------|
| Token 安全 | 仅创建时完整展示，后续脱敏显示 |
| 权限控制 | 基于 RBAC，区分查看/编辑/管理权限 |
| 数据隔离 | 不同业务数据严格隔离 |
| 操作审计 | 关键配置变更记录审计日志 |

### 6.3 兼容性要求

**RUM SDK 兼容性：**

| 平台 | 版本要求 |
|------|----------|
| Web | Chrome 60+, Firefox 55+, Safari 12+, Edge 79+ |
| iOS | iOS 11.0+ |
| Android | Android 5.0+ (API 21+) |
| 小程序 | 微信基础库 2.10.0+ |

---

## 七、版本规划

### 7.1 MVP 版本（v1.0）

- [x] 应用列表与创建
- [x] 基本信息设置
- [x] SDK 接入指引与代码生成
- [x] 数据采集开关与采样率
- [x] Web Vitals 阈值配置
- [x] Apdex 配置

### 7.2 v1.1 版本

- [x] 页面分组规则（自动参数化 + 自定义规则）
- [x] 过滤规则（URL / 错误 / API）
- [x] 告警规则配置
- [x] 综合评分权重配置
- [x] Source Map 管理
- [x] 多环境配置

### 7.3 v1.2 版本（规划中）

- [ ] 敏感数据脱敏规则
- [ ] 数据保留策略配置
- [ ] 自定义维度配置
- [ ] 会话回放功能

---

## 八、术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| RUM | Real User Monitoring | 真实用户监控 |
| Web Vitals | Web Vitals | Google 核心网页性能指标 |
| LCP | Largest Contentful Paint | 最大内容绘制 |
| FID | First Input Delay | 首次输入延迟 |
| CLS | Cumulative Layout Shift | 累积布局偏移 |
| INP | Interaction to Next Paint | 交互到下次绘制 |
| TTFB | Time to First Byte | 首字节时间 |
| FCP | First Contentful Paint | 首次内容绘制 |
| Apdex | Application Performance Index | 应用性能指数 |
| Source Map | Source Map | 源代码映射文件 |

---

## 九、修订记录

| 版本 | 日期 | 修订内容 |
|------|------|----------|
| v1.0 | 2026-02-05 | 初稿创建 |
| v2.0 | 2026-02-05 | 根据原型优化，新增页面规则模块，完善 API 请求配置 |
