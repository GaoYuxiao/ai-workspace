# RUM 应用接入 - 需求文档 v1.0

## 文档信息

| 属性 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2026-02-05 |
| 文档状态 | 草稿 |
| 产品模块 | RUM（Real User Monitoring）- 应用接入 |

---

## 一、需求背景

### 1.1 背景说明

Real User Monitoring（RUM，真实用户监控）是前端性能监控的核心能力，通过在用户端采集真实的性能数据、错误信息、用户行为等，帮助开发和运维团队：

- 了解真实用户的访问体验
- 快速定位和解决前端问题
- 持续优化产品性能和稳定性
- 量化用户体验指标

### 1.2 目标用户

- 前端开发工程师
- 运维/SRE 工程师
- 产品经理
- 技术负责人

### 1.3 核心价值

1. **可观测性**：全面采集页面性能、错误、请求等数据
2. **问题定位**：快速发现和定位用户侧问题
3. **体验量化**：通过 Apdex、Web Vitals 等指标量化用户体验
4. **持续优化**：基于数据驱动的性能优化闭环

---

## 二、功能优先级总览

### 2.1 优先级定义

| 优先级 | 定义 | 说明 |
|--------|------|------|
| **P0** | 核心必备 | MVP 版本必须实现，缺少则无法使用 |
| **P1** | 重要功能 | 核心体验相关，第二阶段实现 |
| **P2** | 增强功能 | 提升用户体验，后续迭代实现 |

### 2.2 功能优先级矩阵

| 功能模块 | 子功能 | 优先级 | 说明 |
|----------|--------|--------|------|
| **基本信息设置** | 应用创建与管理 | P0 | 应用接入的基础 |
| **SDK 接入配置** | 接入指引与代码生成 | P0 | 用户完成接入的前提 |
| **SDK 接入配置** | 多环境配置 | P1 | 区分环境的数据隔离 |
| **数据采集配置** | 采集项开关 | P0 | 控制采集范围 |
| **数据采集配置** | 自定义上报配置 | P1 | 业务埋点支持 |
| **采样设置** | 全局采样率 | P0 | 控制数据量成本 |
| **采样设置** | 分类采样率 | P1 | 精细化采样控制 |
| **过滤设置** | URL/错误过滤 | P1 | 过滤无效数据 |
| **过滤设置** | 敏感数据脱敏 | P2 | 数据安全合规 |
| **阈值设置** | 性能指标阈值 | P0 | 定义性能好坏标准 |
| **阈值设置** | 告警规则配置 | P1 | 异常主动通知 |
| **用户体验评分** | Apdex 配置 | P0 | 核心体验指标 |
| **用户体验评分** | 综合评分配置 | P1 | 多维度体验评估 |
| **高级设置** | Source Map 管理 | P1 | 错误堆栈还原 |
| **高级设置** | 数据保留策略 | P2 | 存储成本控制 |
| **高级设置** | 自定义维度 | P2 | 业务分析扩展 |

---

## 三、功能详细设计

### 3.1 基本信息设置【P0】

#### 3.1.1 功能概述

应用是 RUM 数据管理的基本单元，用户需要先创建应用，获取接入凭证后才能开始数据采集。

#### 3.1.2 页面入口

- 菜单路径：`RUM > 应用管理 > 新建应用` / `应用列表`

#### 3.1.3 字段定义

| 字段名 | 字段标识 | 类型 | 必填 | 说明 | 校验规则 |
|--------|----------|------|------|------|----------|
| 应用名称 | app_name | String | 是 | 用于展示的可读名称 | 2-64字符，支持中英文、数字、下划线、中划线 |
| 应用别名 | app_alias | String | 否 | 英文标识，用于 API 调用 | 2-32字符，仅支持小写英文、数字、下划线 |
| 应用 Token | app_token | String | 自动 | SDK 初始化的唯一凭证 | 系统自动生成，32位随机字符串 |
| 应用类型 | app_type | Enum | 是 | 应用平台类型 | 见下方枚举值 |
| 所属业务 | bk_biz_id | Int | 是 | 关联的 CMDB 业务 | 下拉选择，需有业务权限 |
| 负责人 | owners | Array | 是 | 应用负责人列表 | 至少 1 人，最多 10 人 |
| 应用描述 | description | String | 否 | 应用简介说明 | 最多 500 字符 |
| 域名白名单 | domain_whitelist | Array | 是 | 允许上报的域名 | 支持通配符，如 `*.example.com` |
| 应用状态 | status | Enum | 是 | 启用/停用 | 默认启用 |
| 创建时间 | created_at | DateTime | 自动 | 应用创建时间 | 系统自动生成 |
| 更新时间 | updated_at | DateTime | 自动 | 最后修改时间 | 系统自动更新 |

#### 3.1.4 应用类型枚举

| 枚举值 | 显示名称 | 说明 |
|--------|----------|------|
| web | Web 应用 | PC/移动端网页 |
| ios | iOS 应用 | iOS 原生 App |
| android | Android 应用 | Android 原生 App |
| miniprogram | 小程序 | 微信/支付宝等小程序 |
| hybrid | Hybrid 应用 | 混合应用 |

#### 3.1.5 交互说明

1. **新建应用**
   - 点击「新建应用」按钮，弹出侧滑抽屉表单
   - 填写基本信息后，点击「提交」创建应用
   - 创建成功后，自动跳转到「SDK 接入指引」页面

2. **应用列表**
   - 支持按应用名称、类型、状态筛选
   - 支持按创建时间、更新时间排序
   - 列表展示：应用名称、类型、Token（脱敏）、状态、负责人、操作

3. **编辑应用**
   - 应用 Token 创建后不可修改
   - 应用类型创建后不可修改
   - 其他字段支持编辑

4. **删除应用**
   - 需二次确认，提示「删除后该应用的所有监控数据将被清除，且无法恢复」
   - 只有应用负责人可删除

#### 3.1.6 接口设计

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建应用 | POST | /api/rum/apps/ | 创建新应用 |
| 应用列表 | GET | /api/rum/apps/ | 获取应用列表 |
| 应用详情 | GET | /api/rum/apps/{app_id}/ | 获取应用详情 |
| 更新应用 | PUT | /api/rum/apps/{app_id}/ | 更新应用信息 |
| 删除应用 | DELETE | /api/rum/apps/{app_id}/ | 删除应用 |
| 重置 Token | POST | /api/rum/apps/{app_id}/reset_token/ | 重置应用 Token |

---

### 3.2 SDK 接入配置【P0/P1】

#### 3.2.1 功能概述

提供 SDK 接入指引，帮助用户快速将 RUM SDK 集成到应用中，开始数据采集。

#### 3.2.2 接入方式【P0】

根据应用类型提供不同的接入方式：

**Web 应用接入方式：**

| 接入方式 | 说明 | 适用场景 |
|----------|------|----------|
| CDN Script | 通过 `<script>` 标签引入 | 快速接入，无构建工具项目 |
| NPM 包 | 通过包管理器安装 | 现代前端工程项目 |

**移动端/小程序接入方式：**

| 平台 | 接入方式 | 说明 |
|------|----------|------|
| iOS | CocoaPods / SPM | 原生 SDK 集成 |
| Android | Maven / Gradle | 原生 SDK 集成 |
| 小程序 | NPM 包 | 小程序 SDK 集成 |

#### 3.2.3 初始化代码生成【P0】

根据用户配置动态生成可复制的初始化代码：

**Web CDN 接入示例：**

```html
<script src="https://static.example.com/rum-sdk/v1.0.0/rum.min.js"></script>
<script>
  window.BKRUM && window.BKRUM.init({
    token: 'your-app-token',
    reportUrl: 'https://rum.example.com/api/v1/report',
    appVersion: '1.0.0',
    environment: 'production',
    sampleRate: 100,
    enableWebVitals: true,
    enableJsError: true,
    enableResource: true,
    enableApi: true
  });
</script>
```

**Web NPM 接入示例：**

```javascript
import { init } from '@bkmonitor/rum-sdk';

init({
  token: 'your-app-token',
  reportUrl: 'https://rum.example.com/api/v1/report',
  appVersion: '1.0.0',
  environment: 'production',
  sampleRate: 100,
  enableWebVitals: true,
  enableJsError: true,
  enableResource: true,
  enableApi: true
});
```

#### 3.2.4 SDK 配置参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| token | String | 是 | - | 应用 Token |
| reportUrl | String | 是 | - | 数据上报地址 |
| appVersion | String | 否 | - | 应用版本号 |
| environment | String | 否 | production | 环境标识 |
| sampleRate | Number | 否 | 100 | 采样率 (0-100) |
| enableWebVitals | Boolean | 否 | true | 开启 Web Vitals 采集 |
| enableJsError | Boolean | 否 | true | 开启 JS 错误采集 |
| enableResource | Boolean | 否 | true | 开启资源加载采集 |
| enableApi | Boolean | 否 | true | 开启 API 请求采集 |
| enableUserAction | Boolean | 否 | false | 开启用户行为采集 |
| userId | String | 否 | - | 用户标识 |
| customTags | Object | 否 | {} | 自定义标签 |

#### 3.2.5 多环境配置【P1】

支持为同一应用配置多个环境，数据按环境隔离：

| 字段 | 说明 |
|------|------|
| 环境标识 | development / testing / staging / production |
| 环境名称 | 自定义环境名称 |
| 独立配置 | 每个环境可独立配置采样率、采集项等 |

#### 3.2.6 页面布局

```
┌─────────────────────────────────────────────────────────────────┐
│  SDK 接入指引                                                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐                                           │
│  │ ① 选择接入方式   │  ○ CDN Script    ○ NPM 包                 │
│  └──────────────────┘                                           │
│                                                                  │
│  ┌──────────────────┐                                           │
│  │ ② 配置选项       │                                           │
│  │                  │  应用版本: [________]                     │
│  │                  │  环境标识: [production ▼]                 │
│  │                  │  采样率:   [100] %                        │
│  │                  │                                           │
│  │  采集项开关:     │  ☑ Web Vitals  ☑ JS错误  ☑ 资源加载      │
│  │                  │  ☑ API请求    ☐ 用户行为                 │
│  └──────────────────┘                                           │
│                                                                  │
│  ┌──────────────────┐                                           │
│  │ ③ 复制代码       │                                           │
│  │  ┌────────────────────────────────────────────┐  [复制]      │
│  │  │ <script src="..."></script>                │              │
│  │  │ <script>                                   │              │
│  │  │   window.BKRUM && window.BKRUM.init({     │              │
│  │  │     token: 'xxx',                          │              │
│  │  │     ...                                    │              │
│  │  │   });                                      │              │
│  │  │ </script>                                  │              │
│  │  └────────────────────────────────────────────┘              │
│  └──────────────────┘                                           │
│                                                                  │
│  ┌──────────────────┐                                           │
│  │ ④ 验证接入       │  [检测数据上报]                           │
│  │                  │  ● 已检测到数据上报，接入成功！            │
│  └──────────────────┘                                           │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3.3 数据采集配置【P0/P1】

#### 3.3.1 功能概述

控制 SDK 采集哪些类型的数据，用户可根据需求开启或关闭特定数据类型的采集。

#### 3.3.2 采集项配置【P0】

| 采集项 | 标识 | 默认状态 | 说明 | 采集内容 |
|--------|------|----------|------|----------|
| 页面访问 | page_view | 开启 | 页面 PV、UV 统计 | URL、Referrer、停留时长 |
| Web Vitals | web_vitals | 开启 | 核心性能指标 | LCP、FID、CLS、INP、TTFB、FCP |
| 页面加载性能 | page_performance | 开启 | Navigation Timing | DNS、TCP、TTFB、DOM解析、页面加载时间 |
| JS 错误 | js_error | 开启 | JavaScript 运行时错误 | 错误类型、消息、堆栈、发生位置 |
| Promise 异常 | promise_rejection | 开启 | 未捕获的 Promise rejection | 异常信息、堆栈 |
| 资源加载 | resource | 开启 | 静态资源加载性能 | 资源类型、URL、加载时间、状态 |
| API 请求 | api_request | 开启 | XHR/Fetch 请求监控 | URL、方法、状态码、耗时 |
| 用户行为 | user_action | 关闭 | 用户交互行为 | 点击、输入、滚动事件 |
| 长任务 | long_task | 开启 | Long Task 监控 | 任务时长、发生时间 |
| 会话回放 | session_replay | 关闭 | Session Replay 录制 | DOM 变更、用户操作录制 |

#### 3.3.3 采集项详细配置

**API 请求采集配置：**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 采集请求头 | Boolean | false | 是否采集请求头信息 |
| 采集响应头 | Boolean | false | 是否采集响应头信息 |
| 采集请求体 | Boolean | false | 是否采集请求体（需配合脱敏规则） |
| 采集响应体 | Boolean | false | 是否采集响应体（需配合脱敏规则） |
| 慢请求阈值 | Number | 3000 | 超过该时长标记为慢请求（毫秒） |
| URL 白名单 | Array | [] | 仅采集匹配的 URL（为空则全部采集） |
| URL 黑名单 | Array | [] | 不采集匹配的 URL |

**资源加载采集配置：**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 资源类型过滤 | Array | 全部 | 采集的资源类型：script/css/img/font/xhr/fetch |
| 慢资源阈值 | Number | 5000 | 超过该时长标记为慢资源（毫秒） |
| 忽略 CDN 域名 | Array | [] | 不采集指定 CDN 域名的资源 |

#### 3.3.4 自定义上报配置【P1】

支持业务代码主动上报自定义数据：

**自定义事件上报：**

```javascript
// 上报自定义事件
BKRUM.trackEvent('button_click', {
  button_id: 'submit_order',
  page: 'checkout'
});

// 上报自定义指标
BKRUM.trackMetric('api_response_time', 1234, {
  api: '/api/order/create'
});

// 上报自定义错误
BKRUM.trackError(new Error('Custom error message'), {
  module: 'payment'
});
```

**自定义上报限制：**

| 限制项 | 限制值 | 说明 |
|--------|--------|------|
| 事件名长度 | 64 字符 | 自定义事件名称最大长度 |
| 属性数量 | 20 个 | 单次上报最大属性数量 |
| 属性值长度 | 256 字符 | 单个属性值最大长度 |
| 上报频率 | 100 次/分钟 | 单用户自定义上报频率限制 |

---

### 3.4 采样设置【P0/P1】

#### 3.4.1 功能概述

通过采样控制上报的数据量，在数据完整性和成本之间取得平衡。

#### 3.4.2 采样率配置

**全局采样率【P0】：**

| 字段 | 类型 | 范围 | 默认值 | 说明 |
|------|------|------|--------|------|
| 全局采样率 | Number | 0-100 | 100 | 所有数据类型的基础采样率 |

**分类采样率【P1】：**

| 采样类型 | 默认值 | 说明 | 建议值 |
|----------|--------|------|--------|
| 会话采样 | 100% | 按用户会话进行采样，保证单用户数据完整性 | 10-100% |
| 错误采样 | 100% | JS Error、Promise 异常等错误数据 | 100%（建议不采样） |
| 性能采样 | 100% | 页面性能、Web Vitals 数据 | 50-100% |
| 资源采样 | 50% | 静态资源加载数据（数据量大） | 10-50% |
| API 采样 | 100% | API 请求数据 | 50-100% |
| 行为采样 | 100% | 用户行为数据 | 10-50% |
| 长任务采样 | 50% | Long Task 数据 | 10-50% |

#### 3.4.3 采样策略说明

1. **分类采样优先级**：分类采样率 × 全局采样率 = 最终采样率
2. **会话一致性**：同一用户会话内的数据采样结果保持一致
3. **错误优先**：建议错误类数据保持 100% 采样，确保问题不遗漏

#### 3.4.4 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│  采样设置                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  全局采样率                                                      │
│  ├────────────────────────────────────────────────────┤ 100%    │
│  控制所有数据类型的基础采样比例                                   │
│                                                                  │
│  ─────────────────────────────────────────────────────────────  │
│                                                                  │
│  分类采样率（可选）                                               │
│                                                                  │
│  │ 数据类型     │ 采样率  │ 预估数据量/日  │                     │
│  │─────────────│────────│───────────────│                     │
│  │ 错误数据     │ 100%   │ ~50 MB        │                     │
│  │ 性能数据     │ 100%   │ ~200 MB       │                     │
│  │ 资源数据     │ 50%    │ ~500 MB       │                     │
│  │ API 请求     │ 100%   │ ~300 MB       │                     │
│  │ 用户行为     │ 10%    │ ~100 MB       │                     │
│  │ 长任务       │ 50%    │ ~50 MB        │                     │
│                                                                  │
│  预估总数据量：~1.2 GB/日                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3.5 过滤设置【P1/P2】

#### 3.5.1 功能概述

过滤无效数据和噪音数据，提高数据质量，减少存储成本。

#### 3.5.2 URL 过滤规则【P1】

| 字段 | 类型 | 说明 |
|------|------|------|
| 过滤类型 | Enum | 黑名单（排除）/ 白名单（仅包含） |
| 匹配模式 | Enum | 精确匹配 / 前缀匹配 / 正则匹配 |
| URL 规则 | Array | URL 规则列表 |

**常用过滤场景：**

| 场景 | 规则示例 | 说明 |
|------|----------|------|
| 排除健康检查 | `/health*`, `/ping` | 过滤健康检查接口 |
| 排除监控接口 | `/api/rum/report*` | 过滤 RUM 上报接口本身 |
| 排除静态资源 | `*.map`, `*.ico` | 过滤 Source Map 等文件 |
| 仅监控生产 | `*.prod.example.com` | 仅监控生产环境域名 |

#### 3.5.3 错误过滤规则【P1】

| 字段 | 类型 | 说明 |
|------|------|------|
| 错误消息过滤 | Array | 按错误消息内容过滤（支持正则） |
| 错误类型过滤 | Array | 按错误类型过滤 |
| 来源过滤 | Array | 按错误来源文件过滤 |

**常用错误过滤规则：**

| 规则 | 说明 |
|------|------|
| `Script error.` | 跨域脚本错误（无具体信息） |
| `ResizeObserver loop` | ResizeObserver 循环警告 |
| `Network Error` | 网络断开导致的错误 |
| `chrome-extension://` | 浏览器插件导致的错误 |

#### 3.5.4 用户过滤规则【P1】

| 字段 | 类型 | 说明 |
|------|------|------|
| 排除用户 ID | Array | 排除指定用户的数据（如内部测试账号） |
| 排除 IP 段 | Array | 排除指定 IP 范围（如公司内网 IP） |
| 排除 User-Agent | Array | 排除指定 UA（如爬虫、自动化测试） |

#### 3.5.5 敏感数据脱敏【P2】

| 脱敏类型 | 配置项 | 说明 |
|----------|--------|------|
| URL 参数脱敏 | 参数名列表 | 如 `token`, `password`, `secret` |
| 请求体脱敏 | 字段路径列表 | 如 `user.password`, `card.cvv` |
| 响应体脱敏 | 字段路径列表 | 如 `data.mobile`, `data.idcard` |
| 正则脱敏 | 正则规则列表 | 匹配的内容替换为 `***` |

**内置脱敏规则：**

| 规则名称 | 正则模式 | 说明 |
|----------|----------|------|
| 手机号 | `1[3-9]\d{9}` | 中国大陆手机号 |
| 身份证 | `\d{17}[\dXx]` | 18位身份证号 |
| 银行卡 | `\d{16,19}` | 银行卡号 |
| 邮箱 | `\w+@\w+\.\w+` | 邮箱地址 |

---

### 3.6 阈值设置【P0/P1】

#### 3.6.1 功能概述

定义各类性能指标和业务指标的阈值标准，用于：
- 数据分类统计（好/中/差）
- 触发告警通知
- 计算用户体验评分

#### 3.6.2 Web Vitals 阈值【P0】

基于 Google Web Vitals 标准，支持自定义调整：

| 指标 | 标识 | 良好 (Good) | 需改进 (Needs Improvement) | 差 (Poor) | 单位 |
|------|------|-------------|---------------------------|-----------|------|
| LCP | lcp | ≤ 2500 | 2500 - 4000 | > 4000 | ms |
| FID | fid | ≤ 100 | 100 - 300 | > 300 | ms |
| CLS | cls | ≤ 0.1 | 0.1 - 0.25 | > 0.25 | - |
| INP | inp | ≤ 200 | 200 - 500 | > 500 | ms |
| TTFB | ttfb | ≤ 800 | 800 - 1800 | > 1800 | ms |
| FCP | fcp | ≤ 1800 | 1800 - 3000 | > 3000 | ms |

#### 3.6.3 页面加载阈值【P0】

| 指标 | 标识 | 良好 | 需改进 | 差 | 单位 |
|------|------|------|--------|-----|------|
| 页面完全加载时间 | page_load | ≤ 3000 | 3000 - 5000 | > 5000 | ms |
| DOM Ready 时间 | dom_ready | ≤ 2000 | 2000 - 4000 | > 4000 | ms |
| 首字节时间 | ttfb | ≤ 500 | 500 - 1000 | > 1000 | ms |

#### 3.6.4 业务阈值【P0】

| 指标 | 标识 | 警告阈值 | 严重阈值 | 单位 | 说明 |
|------|------|----------|----------|------|------|
| JS 错误率 | js_error_rate | 1% | 5% | % | 错误PV / 总PV |
| API 失败率 | api_error_rate | 1% | 5% | % | 失败请求 / 总请求 |
| 资源加载失败率 | resource_error_rate | 5% | 10% | % | 失败资源 / 总资源 |
| 慢请求占比 | slow_request_rate | 5% | 15% | % | 慢请求 / 总请求 |
| 慢页面占比 | slow_page_rate | 10% | 30% | % | 慢页面 / 总PV |

#### 3.6.5 告警规则配置【P1】

**告警规则字段：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 规则名称 | String | 是 | 告警规则名称 |
| 监控指标 | Enum | 是 | 选择要监控的指标 |
| 触发条件 | Object | 是 | 阈值和持续时间 |
| 告警级别 | Enum | 是 | 提醒/警告/严重 |
| 通知渠道 | Array | 是 | 企业微信/邮件/短信/Webhook |
| 通知对象 | Array | 是 | 接收告警的人员/群组 |
| 生效时间 | Object | 否 | 告警生效的时间范围 |
| 告警收敛 | Object | 否 | 相同告警合并配置 |

**触发条件配置：**

| 字段 | 类型 | 说明 |
|------|------|------|
| 比较方式 | Enum | 大于/小于/等于/大于等于/小于等于 |
| 阈值 | Number | 触发告警的阈值 |
| 持续周期 | Number | 连续满足条件的周期数 |
| 检测周期 | Number | 每次检测的时间间隔（分钟） |

**告警级别定义：**

| 级别 | 标识 | 颜色 | 说明 |
|------|------|------|------|
| 提醒 | info | 蓝色 | 需要关注，非紧急 |
| 警告 | warning | 黄色 | 需要处理，有影响 |
| 严重 | critical | 红色 | 紧急处理，严重影响 |

**告警收敛配置：**

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| 收敛窗口 | Number | 60 | 同一告警合并的时间窗口（分钟） |
| 最大通知次数 | Number | 3 | 收敛窗口内最大通知次数 |
| 恢复通知 | Boolean | true | 告警恢复时是否发送通知 |

---

### 3.7 用户体验评分设置【P0/P1】

#### 3.7.1 功能概述

通过量化指标评估用户体验质量，提供统一的体验评分标准。

#### 3.7.2 Apdex 配置【P0】

**Apdex 概念说明：**

Apdex（Application Performance Index）是衡量用户满意度的工业标准：
- **满意 (Satisfied)**：响应时间 ≤ T
- **可容忍 (Tolerating)**：T < 响应时间 ≤ 4T
- **不满意 (Frustrated)**：响应时间 > 4T

**Apdex 计算公式：**
```
Apdex = (满意数 + 可容忍数 × 0.5) / 总样本数
```

**Apdex 配置项：**

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| 满意阈值 T（页面加载） | Number | 2000 | 页面加载时间的满意阈值（毫秒） |
| 满意阈值 T（API 请求） | Number | 500 | API 请求时间的满意阈值（毫秒） |
| 计算维度 | Enum | page | 按页面/API/整体计算 |

**Apdex 等级划分：**

| Apdex 值 | 等级 | 说明 |
|----------|------|------|
| 0.94 - 1.00 | 优秀 | 用户非常满意 |
| 0.85 - 0.93 | 良好 | 用户满意 |
| 0.70 - 0.84 | 一般 | 部分用户不满 |
| 0.50 - 0.69 | 较差 | 用户抱怨较多 |
| 0.00 - 0.49 | 极差 | 用户非常不满 |

#### 3.7.3 综合体验评分配置【P1】

**评分维度与权重：**

| 维度 | 标识 | 默认权重 | 说明 | 计算依据 |
|------|------|----------|------|----------|
| 页面性能 | performance | 40% | 页面加载速度评分 | Web Vitals 综合得分 |
| 稳定性 | stability | 30% | 应用稳定性评分 | JS 错误率、API 成功率 |
| 可用性 | availability | 20% | 资源可用性评分 | 资源加载成功率 |
| 交互体验 | interaction | 10% | 交互响应评分 | FID、INP、长任务占比 |

**各维度计算规则：**

**页面性能评分（满分100）：**
```
性能得分 = LCP得分×30% + FCP得分×25% + TTFB得分×20% + CLS得分×15% + INP得分×10%

其中单项得分：
- 良好(Good)：100分
- 需改进：60分
- 差(Poor)：20分
```

**稳定性评分（满分100）：**
```
稳定性得分 = (1 - JS错误率) × 50 + API成功率 × 50
```

**可用性评分（满分100）：**
```
可用性得分 = 资源加载成功率 × 100
```

**交互体验评分（满分100）：**
```
交互体验得分 = FID得分×40% + INP得分×40% + (1-长任务占比)×20%
```

**综合评分：**
```
综合评分 = 性能得分×40% + 稳定性得分×30% + 可用性得分×20% + 交互体验得分×10%
```

#### 3.7.4 评分等级定义

| 评分区间 | 等级 | 标签颜色 | 说明 |
|----------|------|----------|------|
| 90 - 100 | 优秀 | #52C41A (绿色) | 用户体验优秀 |
| 75 - 89 | 良好 | #1890FF (蓝色) | 用户体验良好 |
| 60 - 74 | 一般 | #FAAD14 (黄色) | 用户体验一般，建议优化 |
| 0 - 59 | 较差 | #FF4D4F (红色) | 用户体验较差，需要改进 |

#### 3.7.5 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│  用户体验评分设置                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Apdex 配置                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  满意阈值 T                                              │    │
│  │  页面加载：[2000] ms    API请求：[500] ms                │    │
│  │                                                          │    │
│  │  阈值说明：                                              │    │
│  │  • 满意：响应时间 ≤ T                                    │    │
│  │  • 可容忍：T < 响应时间 ≤ 4T                            │    │
│  │  • 不满意：响应时间 > 4T                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  综合评分权重配置                                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  维度         │ 权重   │ 说明                           │    │
│  │───────────────│────────│────────────────────────────────│    │
│  │  页面性能     │ [40]%  │ Web Vitals 综合得分            │    │
│  │  稳定性       │ [30]%  │ 错误率、API 成功率             │    │
│  │  可用性       │ [20]%  │ 资源加载成功率                 │    │
│  │  交互体验     │ [10]%  │ 交互响应速度                   │    │
│  │───────────────│────────│────────────────────────────────│    │
│  │  合计         │ 100%   │                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  评分等级配置                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ■ 优秀 (90-100)  ■ 良好 (75-89)                        │    │
│  │  ■ 一般 (60-74)   ■ 较差 (0-59)                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│                                      [恢复默认]  [保存]          │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3.8 高级设置【P1/P2】

#### 3.8.1 Source Map 管理【P1】

**功能说明：**

Source Map 用于将压缩/混淆后的 JavaScript 代码映射回原始代码，方便错误定位。

**配置项：**

| 字段 | 类型 | 说明 |
|------|------|------|
| 开启 Source Map 解析 | Boolean | 是否开启错误堆栈还原 |
| 上传方式 | Enum | 手动上传 / CI/CD 自动上传 / 远程拉取 |
| Source Map 存储路径 | String | 上传的 Source Map 文件存储路径 |
| 版本关联 | String | 关联的应用版本号 |

**Source Map 上传 API：**

```bash
# 通过 CI/CD 上传 Source Map
curl -X POST 'https://rum.example.com/api/rum/apps/{app_id}/sourcemap/' \
  -H 'Authorization: Bearer {token}' \
  -F 'version=1.0.0' \
  -F 'files=@./dist/app.js.map'
```

**Source Map 管理列表：**

| 字段 | 说明 |
|------|------|
| 版本号 | 应用版本 |
| 文件名 | Source Map 文件名 |
| 文件大小 | 文件大小 |
| 上传时间 | 上传时间 |
| 操作 | 下载、删除 |

#### 3.8.2 数据保留策略【P2】

| 数据类型 | 默认保留期 | 可选范围 | 说明 |
|----------|------------|----------|------|
| 原始明细数据 | 7 天 | 1-30 天 | 完整的原始上报数据 |
| 聚合统计数据 | 90 天 | 30-365 天 | 按分钟/小时/天聚合的数据 |
| 错误详情数据 | 30 天 | 7-90 天 | 错误堆栈等详情数据 |
| 会话回放数据 | 3 天 | 1-7 天 | Session Replay 录制数据 |

#### 3.8.3 自定义维度【P2】

支持在上报数据中添加业务自定义维度，用于精细化分析：

| 字段 | 类型 | 说明 |
|------|------|------|
| 维度名称 | String | 维度的显示名称 |
| 维度标识 | String | 维度的字段标识 |
| 维度类型 | Enum | 字符串 / 数字 / 布尔 |
| 维度来源 | Enum | SDK 自动采集 / 业务代码上报 |

**常用自定义维度示例：**

| 维度 | 标识 | 说明 |
|------|------|------|
| 用户类型 | user_type | VIP / 普通用户 |
| 用户等级 | user_level | 用户等级 |
| AB 实验组 | ab_group | 实验分组标识 |
| 渠道来源 | channel | 流量渠道 |
| 功能模块 | module | 业务功能模块 |

---

## 四、数据模型设计

### 4.1 应用配置数据模型

```json
{
  "id": 1,
  "app_token": "rum_xxxxxxxxxxxxxxxx",
  "app_name": "示例应用",
  "app_alias": "example_app",
  "app_type": "web",
  "bk_biz_id": 2,
  "owners": ["admin", "developer"],
  "description": "这是一个示例应用",
  "domain_whitelist": ["*.example.com", "localhost"],
  "status": "enabled",
  "config": {
    "sdk": {
      "report_url": "https://rum.example.com/api/v1/report",
      "environments": [
        {
          "name": "production",
          "sample_rate": 100
        }
      ]
    },
    "collection": {
      "page_view": true,
      "web_vitals": true,
      "page_performance": true,
      "js_error": true,
      "promise_rejection": true,
      "resource": true,
      "api_request": true,
      "user_action": false,
      "long_task": true,
      "session_replay": false
    },
    "sampling": {
      "global_rate": 100,
      "error_rate": 100,
      "performance_rate": 100,
      "resource_rate": 50,
      "api_rate": 100,
      "action_rate": 100,
      "long_task_rate": 50
    },
    "filter": {
      "url_rules": [],
      "error_rules": [],
      "user_rules": [],
      "sensitive_rules": []
    },
    "threshold": {
      "web_vitals": {
        "lcp": {"good": 2500, "poor": 4000},
        "fid": {"good": 100, "poor": 300},
        "cls": {"good": 0.1, "poor": 0.25},
        "inp": {"good": 200, "poor": 500},
        "ttfb": {"good": 800, "poor": 1800},
        "fcp": {"good": 1800, "poor": 3000}
      },
      "business": {
        "js_error_rate": {"warning": 0.01, "critical": 0.05},
        "api_error_rate": {"warning": 0.01, "critical": 0.05},
        "resource_error_rate": {"warning": 0.05, "critical": 0.10},
        "slow_request_rate": {"warning": 0.05, "critical": 0.15}
      }
    },
    "scoring": {
      "apdex": {
        "page_threshold": 2000,
        "api_threshold": 500
      },
      "weights": {
        "performance": 40,
        "stability": 30,
        "availability": 20,
        "interaction": 10
      }
    },
    "advanced": {
      "sourcemap_enabled": true,
      "data_retention": {
        "raw_data_days": 7,
        "aggregated_data_days": 90,
        "error_data_days": 30
      },
      "custom_dimensions": []
    }
  },
  "created_at": "2026-02-05T10:00:00Z",
  "updated_at": "2026-02-05T10:00:00Z"
}
```

---

## 五、页面原型

### 5.1 应用列表页

```
┌─────────────────────────────────────────────────────────────────────────┐
│  RUM > 应用管理                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [+ 新建应用]                                              [🔍 搜索应用] │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ 应用名称      │ 类型 │ Token        │ 状态  │ 负责人   │ 操作     │ │
│  │───────────────│──────│──────────────│───────│──────────│──────────│ │
│  │ 官网首页      │ Web  │ rum_xxx...   │ ● 启用│ admin    │ 配置 删除│ │
│  │ 移动端 App    │ iOS  │ rum_yyy...   │ ● 启用│ dev      │ 配置 删除│ │
│  │ 小程序商城    │ 小程序│ rum_zzz...   │ ○ 停用│ ops      │ 配置 删除│ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│                                           < 1 2 3 ... 10 >               │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 应用配置页（Tab 布局）

```
┌─────────────────────────────────────────────────────────────────────────┐
│  RUM > 应用管理 > 官网首页                                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 基本信息 │ SDK接入 │ 数据采集 │ 采样过滤 │ 阈值告警 │ 体验评分 │ 高级 │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │                        [当前 Tab 内容区域]                          │ │
│  │                                                                     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│                                                     [取消]  [保存]       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 六、版本规划

### 6.1 MVP 版本（v1.0）

**目标：** 完成基础接入能力，用户可以创建应用并接入 SDK 开始数据采集。

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 基本信息设置 | P0 | 应用创建、编辑、删除、列表 |
| SDK 接入配置 | P0 | 接入指引、代码生成、接入验证 |
| 数据采集开关 | P0 | 采集项开关配置 |
| 全局采样率 | P0 | 基础采样率配置 |
| 性能指标阈值 | P0 | Web Vitals 阈值配置 |
| Apdex 配置 | P0 | 基础 Apdex 配置 |

### 6.2 v1.1 版本

**目标：** 完善配置能力，增加告警和精细化控制。

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 分类采样率 | P1 | 按数据类型配置采样率 |
| 过滤规则 | P1 | URL、错误、用户过滤 |
| 告警规则 | P1 | 阈值告警配置与通知 |
| 综合评分配置 | P1 | 评分权重配置 |
| Source Map | P1 | 上传与管理 |
| 多环境配置 | P1 | 环境隔离配置 |

### 6.3 v1.2 版本

**目标：** 增强功能，提升数据安全与分析能力。

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 敏感数据脱敏 | P2 | 数据脱敏规则配置 |
| 数据保留策略 | P2 | 存储周期配置 |
| 自定义维度 | P2 | 业务维度扩展 |
| 会话回放配置 | P2 | Session Replay 设置 |

---

## 七、非功能性需求

### 7.1 性能要求

| 指标 | 要求 |
|------|------|
| 应用列表加载 | ≤ 500ms |
| 配置保存响应 | ≤ 1s |
| SDK 接入验证 | ≤ 30s 超时 |

### 7.2 安全要求

| 要求 | 说明 |
|------|------|
| Token 安全 | Token 仅在创建时完整展示，后续展示脱敏 |
| 权限控制 | 基于 RBAC，区分查看/编辑/管理权限 |
| 数据隔离 | 不同业务数据严格隔离 |
| 操作审计 | 关键配置变更记录审计日志 |

### 7.3 兼容性要求

| 平台 | 浏览器/版本 |
|------|-------------|
| Web SDK | Chrome 60+, Firefox 55+, Safari 12+, Edge 79+ |
| iOS SDK | iOS 11.0+ |
| Android SDK | Android 5.0+ (API 21+) |
| 小程序 SDK | 微信基础库 2.10.0+ |

---

## 八、术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| RUM | Real User Monitoring | 真实用户监控 |
| Web Vitals | Web Vitals | Google 定义的核心网页性能指标 |
| LCP | Largest Contentful Paint | 最大内容绘制，衡量加载性能 |
| FID | First Input Delay | 首次输入延迟，衡量交互性 |
| CLS | Cumulative Layout Shift | 累积布局偏移，衡量视觉稳定性 |
| INP | Interaction to Next Paint | 交互到下次绘制，衡量整体响应性 |
| TTFB | Time to First Byte | 首字节时间 |
| FCP | First Contentful Paint | 首次内容绘制 |
| Apdex | Application Performance Index | 应用性能指数 |
| Source Map | Source Map | 源代码映射文件 |
| PV | Page View | 页面浏览量 |
| UV | Unique Visitor | 独立访客数 |

---

## 九、修订记录

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|----------|
| v1.0 | 2026-02-05 | - | 初稿创建 |
