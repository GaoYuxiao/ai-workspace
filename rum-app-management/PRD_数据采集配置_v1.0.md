# RUM 数据采集配置 - 需求文档 v1.0

## 文档信息

| 属性 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2026-02-09 |
| 文档状态 | 草稿 |
| 产品模块 | RUM（Real User Monitoring）- 数据采集配置 |

---

## 一、需求背景

### 1.1 背景说明

RUM（Real User Monitoring）通过在用户端采集真实的性能数据、错误信息、用户行为等，帮助团队了解用户真实体验。数据采集配置是 RUM 的核心功能之一，用户需要能够：

- 灵活控制采集哪些类型的数据
- 通过采样率控制数据量和成本
- 针对特定采集项进行精细化配置

### 1.2 目标用户

- 前端开发工程师：配置 SDK 采集项，排查前端问题
- 运维/SRE 工程师：管理监控配置，控制数据成本
- 技术负责人：制定监控策略，平衡数据完整性与成本

### 1.3 核心价值

1. **灵活性**：支持按需开启/关闭各类数据采集
2. **成本控制**：通过采样率控制数据量，降低存储成本
3. **精细化配置**：API 请求等复杂采集项支持详细参数配置
4. **统一管理**：集中管理所有采集项配置，便于维护

### 1.4 权限说明

| 用户角色 | 功能权限 | 权限粒度 |
|----------|----------|----------|
| 应用管理员 | 查看/编辑采集配置 | 按应用 |
| 运维人员 | 查看/编辑采集配置 | 按业务 |
| 开发人员 | 仅查看采集配置 | 按应用 |

---

## 二、功能优先级总览

| 优先级 | 定义 | 说明 |
|--------|------|------|
| **P0** | 核心必备 | MVP 版本必须实现 |
| **P1** | 重要功能 | 第二阶段实现 |
| **P2** | 增强功能 | 后续迭代实现 |

| 功能模块 | 子功能 | 优先级 | 说明 |
|----------|--------|--------|------|
| **采集项配置** | 采集项开关 | P0 | 控制数据采集范围 |
| **采集项配置** | 采样率配置 | P0 | 控制数据量成本 |
| **采集项配置** | API 请求详细配置 | P1 | 精细化 API 采集控制 |
| **采集项配置** | 会话回放配置 | P2 | 高级功能，数据量大 |

---

## 三、功能详细设计

### 3.1 采集项配置【P0】

#### 3.1.1 功能概述

采集项配置是数据采集的核心功能，用户可以控制 SDK 采集哪些类型的数据，并为每种数据类型设置独立的采样率。通过合理配置，用户可以在数据完整性和存储成本之间取得平衡。

#### 3.1.2 功能说明

- 菜单路径：`RUM > 应用管理 > [应用名称] > 数据采集`
- 入口位置：应用配置页面的「数据采集」Tab

#### 3.1.3 页面原型

**数据采集配置页面**

![数据采集配置](./screenshots/03-collection.png)

#### 3.1.4 采集项列表

| 采集项 | 标识 | 默认状态 | 默认采样率 | 说明 |
|--------|------|----------|------------|------|
| 页面访问 | page_view | 开启 | 100% | PV、UV 统计，URL、Referrer、停留时长 |
| Web Vitals | web_vitals | 开启 | 100% | LCP、FID、CLS、INP、TTFB、FCP 核心性能指标 |
| JS 错误 | js_error | 开启 | 100% | JavaScript 运行时错误、Promise 异常（建议100%） |
| 资源加载 | resource | 开启 | 50% | 静态资源加载性能，JS/CSS/图片/字体等 |
| API 请求 | api_request | 开启 | 100% | XHR/Fetch 请求监控，URL、方法、状态码、耗时 |
| 长任务 | long_task | 开启 | 50% | Long Task 监控，执行时间超过 50ms 的任务 |
| 会话回放 | session_replay | 关闭 | 0% | Session Replay 录制，DOM 变更、用户操作录制 |

#### 3.1.5 交互说明

1. **开关切换**
   - 点击采集项右侧的开关，可以开启或关闭该采集项
   - 关闭后，SDK 将不再采集该类型的数据
   - 开关状态实时生效，无需保存

2. **采样率调整**
   - 在采样率输入框中输入 0-100 的数字
   - 采样率表示该类型数据被采集的百分比
   - 建议 JS 错误保持 100% 采样，确保问题不遗漏

3. **保存配置**
   - 修改配置后，点击页面底部的「保存」按钮
   - 保存成功后，配置立即生效
   - SDK 下次初始化时会获取最新配置

---

### 3.2 API 请求详细配置【P1】

#### 3.2.1 功能概述

API 请求是 RUM 监控的重要数据源，支持更精细化的配置选项，包括是否采集请求/响应内容、慢请求阈值等。

#### 3.2.2 功能说明

- 菜单路径：`RUM > 应用管理 > [应用名称] > 数据采集 > API 请求`
- 入口位置：API 请求采集项卡片的展开区域

#### 3.2.3 页面原型

**API 请求配置展开区域**

![API请求详细配置](./screenshots/04-api-request-config.png)

#### 3.2.4 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 采集请求头 | Boolean | false | 是否采集 HTTP 请求头信息 |
| 采集响应头 | Boolean | false | 是否采集 HTTP 响应头信息 |
| 采集请求体 | Boolean | false | 是否采集请求体内容（需配合脱敏规则） |
| 采集响应体 | Boolean | false | 是否采集响应体内容（需配合脱敏规则） |
| 慢请求阈值 | Number | 3000ms | 超过该时长的请求标记为慢请求 |
| 请求体大小限制 | Number | 10KB | 采集请求体的最大大小限制 |

#### 3.2.5 交互说明

1. **展开详细配置**
   - API 请求卡片默认展开显示详细配置
   - 详细配置区域位于采样率和开关下方

2. **勾选采集选项**
   - 勾选对应选项开启该内容的采集
   - 采集请求体/响应体时，会提示需配合脱敏规则

3. **设置阈值**
   - 慢请求阈值：输入毫秒数，用于标记慢请求
   - 请求体大小限制：输入 KB 数，超过限制的内容将被截断

---

### 3.3 会话回放配置【P2】

#### 3.3.1 功能概述

会话回放（Session Replay）可以录制用户在页面上的操作，用于问题复现和用户行为分析。由于数据量较大，默认关闭。

#### 3.3.2 功能说明

- 菜单路径：`RUM > 应用管理 > [应用名称] > 数据采集 > 会话回放`
- 默认状态：关闭
- 采样率：0%

#### 3.3.3 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 开启回放 | Boolean | false | 是否开启会话回放功能 |
| 采样率 | Number | 0% | 回放数据的采样比例 |
| 录制时长 | Number | 30分钟 | 单次会话最大录制时长 |
| 隐私保护 | Boolean | true | 自动遮蔽敏感输入框 |

#### 3.3.4 交互说明

1. **开启会话回放**
   - 点击开关开启功能
   - 开启后需设置合理的采样率（建议 1-5%）

2. **隐私保护**
   - 默认开启隐私保护模式
   - 自动遮蔽 password、credit card 等敏感输入

---

## 四、版本规划

### 4.1 MVP 版本（v1.0）

**目标：** 完成基础采集项配置能力，用户可以控制数据采集范围和采样率。

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 采集项开关 | P0 | 7种采集项的开关控制 |
| 采样率配置 | P0 | 每种采集项独立采样率 |
| 配置持久化 | P0 | 配置保存并同步到 SDK |

### 4.2 v1.1 版本

| 功能 | 优先级 | 说明 |
|------|--------|------|
| API 请求详细配置 | P1 | 请求头/响应头采集、慢请求阈值 |
| 数据预估 | P1 | 根据配置预估每日数据量 |

### 4.3 v1.2 版本

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 会话回放 | P2 | Session Replay 录制功能 |
| 自定义采集项 | P2 | 支持用户自定义采集项 |

---

## 五、数据模型设计

```json
{
  "app_id": "rum_xxxxxxxx",
  "collection_config": {
    "page_view": {
      "enabled": true,
      "sample_rate": 100
    },
    "web_vitals": {
      "enabled": true,
      "sample_rate": 100
    },
    "js_error": {
      "enabled": true,
      "sample_rate": 100
    },
    "resource": {
      "enabled": true,
      "sample_rate": 50
    },
    "api_request": {
      "enabled": true,
      "sample_rate": 100,
      "collect_request_headers": false,
      "collect_response_headers": false,
      "collect_request_body": false,
      "collect_response_body": false,
      "slow_request_threshold": 3000,
      "body_size_limit": 10240
    },
    "long_task": {
      "enabled": true,
      "sample_rate": 50
    },
    "session_replay": {
      "enabled": false,
      "sample_rate": 0,
      "max_duration": 1800,
      "privacy_mode": true
    }
  },
  "updated_at": "2026-02-09T10:00:00Z"
}
```

---

## 六、术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 采集项 | Collection Item | 一类可采集的数据类型 |
| 采样率 | Sample Rate | 数据被采集的百分比 |
| Web Vitals | Web Vitals | Google 定义的核心网页性能指标 |
| Long Task | Long Task | 执行时间超过 50ms 的 JavaScript 任务 |
| Session Replay | Session Replay | 会话回放，录制用户操作 |

---

## 七、修订记录

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|----------|
| v1.0 | 2026-02-09 | AI | 初稿创建，基于 HTML 原型生成 |
